<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempio Ludico — Tavoli</title>
  <meta name="theme-color" content="#ed445b" />

  <style>
    :root{--bg:#ed445b;--ink:#0b0f14;--card:#fff;--muted:#5b6c85;--b:#e5e7eb;--b2:#d1d5db}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;color:#fff;gap:10px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .badge{font-size:12px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:2px 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .grid{display:grid;gap:14px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px;color:var(--ink)}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--b2);border-radius:8px}
    input[readonly]{background:#f9fafb}
    textarea{min-height:88px;resize:vertical}
    button{border:1px solid var(--b2);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#f3f4f6}
    .btn-accent{background:#ed445b;color:#fff;border-color:#d73c52}
    .btn-danger{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--b);border-radius:10px;padding:12px;background:#fff}
    .meta{font-size:12px;color:#6b7280;display:flex;gap:10px;flex-wrap:wrap}
    .thumb{width:100%;height:160px;object-fit:cover;border-radius:8px;border:1px solid var(--b)}
    .noimg{height:160px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--b2);border-radius:8px;color:#6b7280;background:#fafafa}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .tag{font-size:12px;border:1px solid var(--b2);border-radius:999px;padding:2px 8px;background:#f9fafb}
    .hidden{display:none}
    .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:700px){.cols-2{grid-template-columns:1fr}}

    dialog{border:none;border-radius:12px;max-width:900px;width:92vw;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.25);background:#fff}
    .dlg-head{padding:14px 16px;border-bottom:1px solid var(--b);font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .dlg-body{padding:12px 16px;max-height:65vh;overflow:auto}
    .dlg-foot{padding:12px 16px;border-top:1px solid var(--b);display:flex;gap:8px;justify-content:flex-end}

    /* Reservations block */
    .resv{margin-top:10px;padding-top:10px;border-top:1px dashed var(--b2)}
    .resv h4{margin:0 0 6px 0;font-size:13px;color:#374151}
    .resv-list{display:flex;flex-direction:column;gap:6px}
    .resv-row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--b2);border-radius:8px;padding:6px 8px;background:#fff}
    .resv-when{font-size:12px;color:#6b7280;white-space:nowrap}
    .resv-who{flex:1;overflow:hidden;text-overflow:ellipsis}
    .pill{border:1px solid var(--b2);border-radius:999px;padding:1px 6px;font-size:12px}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--b);text-align:left}
    .table th{font-size:12px;color:#374151}
    .table td{font-size:14px}
    .error{color:#dc2626}
    .ok{color:#16a34a}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tempio Ludico — Tavoli</h1>
      <div class="row" style="gap:6px;color:#fff;align-items:center">
        <span class="badge">env:<span id="env-ok">…</span></span>
        <span class="badge">sdk:<span id="sdk-ok">…</span></span>
        <span class="badge">auth:<span id="auth-ok">…</span></span>
        <button id="btn-login" type="button" class="btn-ghost">Login</button>
        <button id="btn-logout" type="button" class="btn-ghost hidden">Logout</button>
        <button id="btn-open-mine" type="button" class="btn-ghost hidden">Le mie prenotazioni</button>
        <button id="btn-open-create" type="button" class="btn-ghost hidden">Crea tavolo</button>
      </div>
    </header>

    <section class="card" style="margin-top:12px">
      <div style="display:flex;gap:8px;align-items:center">
        <img src="LogoTempioLudicoNoBackground.PNG" width="44" height="44" alt="Logo" style="border-radius:50%;border:1px solid rgba(0,0,0,.1)" />
        <div>
          <div class="muted">Tempio Ludico</div>
          <div id="status" class="muted">Pronto</div>
        </div>
      </div>
      <div id="auth-log" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:6px">
        <div class="muted" id="whoami">Utente: —</div>
        <div class="muted" id="role">Ruolo: —</div>
      </div>
    </section>

    <div id="app" class="hidden" aria-hidden="true">
      <section class="card" style="margin-top:14px">
        <div class="row" style="align-items:center">
          <h2 style="flex:1">Elenco tavoli</h2>
          <button id="btn-refresh" type="button">Aggiorna</button>
        </div>
        <div id="tables" class="list"></div>
        <div id="tables-log" class="muted"></div>
      </section>
    </div>
  </div>

  <!-- Le mie prenotazioni -->
  <dialog id="mine-dialog">
    <div class="dlg-head">
      <div>
        <div id="mine-title">Le mie prenotazioni</div>
        <div id="mine-subtitle" class="muted"></div>
      </div>
      <button type="button" onclick="document.getElementById('mine-dialog').close()">Chiudi</button>
    </div>
    <div class="dlg-body">
      <div id="mine"></div>
    </div>
    <div class="dlg-foot">
      <button type="button" onclick="document.getElementById('mine-dialog').close()">Chiudi</button>
    </div>
  </dialog>

  <!-- Modifica Tavolo -->
  <dialog id="edit-dialog">
    <form id="edit-form" method="dialog">
      <div class="dlg-head">
        <div>
          <div>Modifica tavolo</div>
          <div id="edit-subtitle" class="muted"></div>
        </div>
        <button type="button" onclick="document.getElementById('edit-dialog').close()">Chiudi</button>
      </div>
      <div class="dlg-body">
        <input type="hidden" id="edit-id" />
        <div class="cols-2">
          <div>
            <label for="edit-title">Nome tavolo</label>
            <input id="edit-title" required maxlength="120" />
          </div>
          <div>
            <label for="edit-starts_at">Data e ora inizio</label>
            <input id="edit-starts_at" type="datetime-local" required />
          </div>
        </div>

        <div class="cols-2">
          <div>
            <label for="edit-duration">Durata (minuti)</label>
            <input id="edit-duration" type="number" min="1" step="1" required />
          </div>
          <div>
            <label for="edit-max_seats">Posti massimi</label>
            <input id="edit-max_seats" type="number" min="1" max="999" required />
          </div>
        </div>

        <div class="cols-2">
          <div>
            <label for="edit-complexity_label">Complessità</label>
            <select id="edit-complexity_label">
              <option value="molto semplice">Molto semplice</option>
              <option value="semplice">Semplice</option>
              <option value="medio">Medio</option>
              <option value="complesso">Complesso</option>
              <option value="molto complesso">Molto complesso</option>
            </select>
          </div>
          <div>
            <label for="edit-image_url">Immagine (URL)</label>
            <input id="edit-image_url" type="url" placeholder="https://..." />
          </div>
        </div>

        <label for="edit-description">Descrizione</label>
        <textarea id="edit-description" maxlength="2000"></textarea>

        <label for="edit-tags">Tag (separati da virgola)</label>
        <input id="edit-tags" placeholder="boardgame,gdr,..." />
        <div id="edit-error" class="error" style="margin-top:8px"></div>
        <div id="edit-ok" class="ok" style="margin-top:8px"></div>
      </div>
      <div class="dlg-foot">
        <button type="button" class="btn-danger" id="edit-delete">Elimina</button>
        <button type="submit" class="btn-accent">Salva</button>
      </div>
    </form>
  </dialog>

  <!-- Crea Tavolo -->
  <dialog id="create-dialog">
    <form id="create-form" method="dialog">
      <div class="dlg-head">
        <div>
          <div>Crea tavolo</div>
          <div id="create-subtitle" class="muted">Compila tutti i campi obbligatori</div>
        </div>
        <button type="button" onclick="document.getElementById('create-dialog').close()">Chiudi</button>
      </div>
      <div class="dlg-body">
        <div class="cols-2">
          <div>
            <label for="title">Nome tavolo</label>
            <input id="title" required maxlength="120" />
          </div>
          <div>
            <label for="starts_at">Data e ora inizio</label>
            <input id="starts_at" type="datetime-local" required />
          </div>
        </div>

        <div class="cols-2">
          <div>
            <label for="duration_minutes">Durata (minuti)</label>
            <input id="duration_minutes" type="number" min="1" step="1" required />
          </div>
          <div>
            <label for="max_seats">Posti massimi</label>
            <input id="max_seats" type="number" min="1" max="999" required />
          </div>
        </div>

        <div class="cols-2">
          <div>
            <label for="complexity_label">Complessità</label>
            <select id="complexity_label">
              <option value="molto semplice">Molto semplice</option>
              <option value="semplice">Semplice</option>
              <option value="medio" selected>Medio</option>
              <option value="complesso">Complesso</option>
              <option value="molto complesso">Molto complesso</option>
            </select>
          </div>
          <div>
            <label for="image_url">Immagine (URL)</label>
            <input id="image_url" type="url" placeholder="https://..." />
          </div>
        </div>

        <label for="description">Descrizione</label>
        <textarea id="description" maxlength="2000" required placeholder="Dettagli, regolamento, requisiti."></textarea>

        <label for="tags">Tag (separati da virgola)</label>
        <input id="tags" placeholder="boardgame,gdr,..." />
        <div id="create-error" class="error" style="margin-top:8px"></div>
        <div id="create-ok" class="ok" style="margin-top:8px"></div>
      </div>
      <div class="dlg-foot">
        <button type="submit" class="btn-accent">Crea</button>
      </div>
    </form>
  </dialog>

  <!-- Supabase SDK + env -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (iso) => new Date(iso).toLocaleString('it-IT');

    // Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let IS_ADMIN = false;

    function renderAuth(authed){
      $('btn-login').classList.toggle('hidden', authed);
      $('btn-logout').classList.toggle('hidden', !authed);
      $('btn-open-create').classList.toggle('hidden', !authed || !IS_ADMIN);
      $('btn-open-mine').classList.toggle('hidden', !authed);
      $('app').classList.toggle('hidden', !authed);
      $('app').setAttribute('aria-hidden', String(!authed));
      $('auth-ok').textContent = authed ? 'on' : 'off';
    }

    // Helpers for datetime-local <-> ISO
    function isoToLocal(iso){
      if (!iso) return '';
      const d = new Date(iso);
      const pad = n => String(n).padStart(2,'0');
      return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
    }
    function localToIso(localStr){
      const d = new Date(localStr);
      return d.toISOString();
    }
    function parseFutureLocalDateTime(localStr){
      if (!localStr) return { ok:false, error:'Data/ora richiesta' };
      const d = new Date(localStr);
      if (isNaN(d.getTime())) return { ok:false, error:'Data/ora non valida' };
      if (d.getTime() <= Date.now()) return { ok:false, error:'La data/ora deve essere nel futuro' };
      return { ok:true, value: d.toISOString() };
    }

    // ---------- Data ----------
    async function fetchTavoli(){
      const { data, error } = await supabase
        .from('tavoli')
        .select('id,title,description,duration_minutes,starts_at,max_seats,complexity_label,image_url,created_at,creator_id,tags')
        .order('created_at',{ascending:false})
        .limit(200);
      if (error) throw error;
      return data || [];
    }
    async function fetchReservationCounts(){
      const { data, error } = await supabase.from('reservations').select('tavolo_id');
      if (error) throw error;
      const m = new Map();
      for (const r of (data || [])) m.set(r.tavolo_id, (m.get(r.tavolo_id) || 0) + 1);
      return m;
    }
    async function fetchCreatorsUsernames(ids){
      if (!ids.length) return new Map();
      const { data, error } = await supabase.from('profiles').select('id,username').in('id', ids);
      if (error) return new Map();
      const m = new Map();
      for (const r of data || []) m.set(r.id, r.username || null);
      return m;
    }
    async function fetchReservationsByTable(tavoloIds){
      let q = supabase
        .from('v_tavolo_reservations')
        .select('tavolo_id, display_name, status, created_at')
        .order('created_at', { ascending: true });
      if (Array.isArray(tavoloIds) && tavoloIds.length) q = q.in('tavolo_id', tavoloIds);
      const { data, error } = await q;
      if (error) throw error;
      const m = new Map();
      for (const r of data || []) {
        if (!m.has(r.tavolo_id)) m.set(r.tavolo_id, []);
        m.get(r.tavolo_id).push({ who: r.display_name || '—', status: r.status || null, when: r.created_at });
      }
      return m;
    }

    async function listTavoliWithExtras(){
      const { data: userObj } = await supabase.auth.getUser();
      const me = userObj?.user?.id || null;

      const [rows, counts] = await Promise.all([fetchTavoli(), fetchReservationCounts()]);
      const creatorIds = [...new Set(rows.map(r=>r.creator_id).filter(Boolean))];
      const usernames = await fetchCreatorsUsernames(creatorIds);

      const tavoloIds = rows.map(r=>r.id);
      const reservationsByTable = await fetchReservationsByTable(tavoloIds);

      for (const r of rows){
        r.seats_taken = counts.get(r.id) || 0;
        r.me_reserved = false;
        r.resv_list = reservationsByTable.get(r.id) || [];
      }
      if (me){
        const { data: myRes } = await supabase.from('reservations').select('tavolo_id').eq('user_id', me);
        const set = new Set((myRes || []).map(x=>x.tavolo_id));
        for (const r of rows) r.me_reserved = set.has(r.id);
      }
      return { rows, usernames };
    }

    // ---------- UI ----------
    function tavoloCard(t, usernames){
      const el = document.createElement('div');
      el.className='item';
      const hasImg = t.image_url && /^https?:\/\//.test(t.image_url);

      const resvHTML = t.resv_list.length
        ? `<div class="resv">
             <h4>Prenotazioni</h4>
             <div class="resv-list">
               ${t.resv_list.map(x => `
                 <div class="resv-row">
                   <div class="resv-when">${fmt(x.when)}</div>
                   <div class="resv-who">${x.who}</div>
                   ${x.status ? `<div class="pill">${x.status}</div>` : ''}
                 </div>`).join('')}
             </div>
           </div>`
        : `<div class="resv"><h4>Prenotazioni</h4><div class="muted">Nessuna prenotazione</div></div>`;

      el.innerHTML = `
        <div class="grid" style="grid-template-columns:120px 1fr;gap:12px">
          <div>${hasImg ? `<img class="thumb" src="${t.image_url}" alt="">` : `<div class="noimg">Nessuna immagine</div>`}</div>
          <div>
            <h3 style="margin:0">${t.title}</h3>
            <div class="meta">
              <span>${fmt(t.starts_at)}</span>
              <span>${t.duration_minutes ? `${t.duration_minutes} min` : ''}</span>
              <span>Posti: ${t.seats_taken}/${t.max_seats}</span>
              <span>Diff.: ${t.complexity_label||'medio'}</span>
              <span>Creato da: ${usernames.get(t.creator_id) || t.creator_id || '—'}</span>
            </div>
            <p class="muted" style="margin:8px 0 0 0">${t.description||''}</p>
            <div class="tags">${(t.tags||[]).map(x=>`<span class="tag">${x}</span>`).join('')}</div>
            ${resvHTML}
            <div class="row" style="margin-top:10px">
              <button class="btn-accent" data-act="reserve" ${t.seats_taken>=t.max_seats?'disabled':''}>Prenota</button>
              <button class="btn-danger" data-act="cancel" ${t.me_reserved?'':'disabled'}>Cancella</button>
              <button data-act="edit" ${IS_ADMIN?'':'disabled'}>Modifica</button>
              <button data-act="delete" class="btn-danger" ${IS_ADMIN?'':'disabled'}>Elimina</button>
            </div>
          </div>
        </div>`;

      el.querySelector('[data-act="reserve"]').addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const { error } = await supabase.from('reservations').insert({ tavolo_id: t.id });
        if (error) return alert('Errore prenotazione: ' + (error.message || ''));
        await loadTavoli();
      });
      el.querySelector('[data-act="cancel"]').addEventListener('click', async (ev)=>{
        ev.preventDefault();
        const { error } = await supabase.from('reservations').delete().eq('tavolo_id', t.id);
        if (error) return alert('Errore cancellazione: ' + (error.message || ''));
        await loadTavoli();
      });
      el.querySelector('[data-act="edit"]').addEventListener('click', (ev)=>{ ev.preventDefault(); openEdit(t); });
      el.querySelector('[data-act="delete"]').addEventListener('click', async (ev)=>{
        ev.preventDefault();
        if (!confirm('Eliminare questo tavolo?')) return;
        const { error } = await supabase.from('tavoli').delete().eq('id', t.id);
        if (error) return alert('Errore eliminazione: ' + (error.message || ''));
        await loadTavoli();
      });
      return el;
    }

    async function loadTavoli(){
      const host = $('tables'); host.innerHTML=''; $('tables-log').textContent='Caricamento…';
      try{
        const { rows, usernames } = await listTavoliWithExtras();
        if (!rows.length){ host.innerHTML = '<div class="muted">Nessun tavolo</div>'; }
        else {
          const frag = document.createDocumentFragment();
          for (const r of rows) frag.appendChild(tavoloCard(r, usernames));
          host.appendChild(frag);
        }
        $('tables-log').textContent='';
      }catch(err){
        $('tables-log').textContent='Errore: ' + (err.message || '');
      }
    }

    // ----- "Le mie prenotazioni" -----
    async function loadMine(){
      const host = $('mine'); host.innerHTML='';
      const titleEl = $('mine-title');
      const subtitleEl = $('mine-subtitle');

      const { data: userObj } = await supabase.auth.getUser();
      const me = userObj?.user?.id || null;

      let q = supabase
        .from('v_reservations_for_ui')
        .select('reservation_id,tavolo_id,tavolo_title,tavolo_starts_at,user_id,display_name,created_at')
        .order('created_at', { ascending: false });

      if (!IS_ADMIN && me) q = q.eq('user_id', me);

      const { data: rows, error } = await q;
      if (error) { host.innerHTML = `<div class="muted">Errore: ${error.message||error}</div>`; return; }

      titleEl.textContent = IS_ADMIN ? 'Prenotazioni (admin)' : 'Le mie prenotazioni';
      subtitleEl.textContent = rows?.length ? `${rows.length} record` : '';

      if (!rows?.length){
        host.innerHTML = '<div class="muted">Nessuna prenotazione</div>';
        return;
      }

      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:26%">Tavolo</th>
            <th style="width:22%">Data tavolo</th>
            <th style="width:22%">Prenotato il</th>
            <th style="width:22%">Utente</th>
            <th style="width:8%"></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      const { data: meObj } = await supabase.auth.getUser();
      const meId = meObj?.user?.id || null;

      for (const r of rows){
        const tr = document.createElement('tr');
        const canDelete = IS_ADMIN || r.user_id === meId;
        tr.innerHTML = `
          <td>${r.tavolo_title || r.tavolo_id}</td>
          <td>${r.tavolo_starts_at ? new Date(r.tavolo_starts_at).toLocaleString('it-IT') : '—'}</td>
          <td>${new Date(r.created_at).toLocaleString('it-IT')}</td>
          <td>${r.display_name || r.user_id}</td>
          <td><button class="btn-danger" data-id="${r.reservation_id}" ${canDelete?'':'disabled'}>Elimina</button></td>
        `;
        tr.querySelector('button')?.addEventListener('click', async (ev)=>{
          ev.preventDefault();
          if (!confirm('Eliminare questa prenotazione?')) return;
          const { error: delErr } = await supabase.from('reservations').delete().eq('id', r.reservation_id);
          if (delErr) return alert('Errore eliminazione: ' + (delErr.message || ''));
          await loadMine();
          await loadTavoli();
        });
        tbody.appendChild(tr);
      }
      host.appendChild(table);
    }

    // ----- Modifica Tavolo -----
    function openEdit(t){
      if (!IS_ADMIN){ alert('Solo admin.'); return; }
      $('edit-error').textContent = '';
      $('edit-ok').textContent = '';

      $('edit-id').value = t.id;
      $('edit-title').value = t.title || '';
      $('edit-description').value = t.description || '';
      $('edit-starts_at').value = isoToLocal(t.starts_at);
      $('edit-duration').value = t.duration_minutes ?? 60;
      $('edit-max_seats').value = t.max_seats ?? 1;
      $('edit-complexity_label').value = t.complexity_label || 'medio';
      $('edit-image_url').value = t.image_url || '';
      $('edit-tags').value = Array.isArray(t.tags) ? t.tags.join(',') : '';

      $('edit-subtitle').textContent = `ID: ${t.id}`;
      $('edit-dialog').showModal();
    }

    $('edit-delete').addEventListener('click', async (ev)=>{
      ev.preventDefault();
      if (!IS_ADMIN) return alert('Solo admin.');
      const id = $('edit-id').value;
      if (!id) return;
      if (!confirm('Eliminare questo tavolo?')) return;
      const { error } = await supabase.from('tavoli').delete().eq('id', id);
      if (error) { $('edit-error').textContent = error.message || String(error); return; }
      $('edit-ok').textContent = 'Eliminato.';
      await loadTavoli();
      $('edit-dialog').close();
    });

    $('edit-form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if (!IS_ADMIN) return alert('Solo admin.');
      $('edit-error').textContent = '';
      $('edit-ok').textContent = '';

      const id = $('edit-id').value;
      const title = $('edit-title').value.trim();
      const description = $('edit-description').value.trim();
      const starts_local = $('edit-starts_at').value;
      const duration = parseInt($('edit-duration').value, 10);
      const max_seats = parseInt($('edit-max_seats').value, 10);
      const complexity_label = $('edit-complexity_label').value || 'medio';
      const image_url = $('edit-image_url').value.trim();
      const tags = $('edit-tags').value.split(',').map(s=>s.trim()).filter(Boolean);

      if (!title){ $('edit-error').textContent = 'Nome tavolo richiesto.'; return; }
      const dt = parseFutureLocalDateTime(starts_local);
      if (!dt.ok){ $('edit-error').textContent = dt.error; return; }
      if (!Number.isFinite(duration) || duration < 1){ $('edit-error').textContent = 'Durata non valida.'; return; }
      if (!Number.isFinite(max_seats) || max_seats < 1){ $('edit-error').textContent = 'Posti massimi non validi.'; return; }

      const payload = {
        title,
        description,
        starts_at: dt.value,
        duration_minutes: duration,
        max_seats,
        complexity_label,
        image_url: image_url || null,
        tags
      };
      const { error } = await supabase.from('tavoli').update(payload).eq('id', id);
      if (error){ $('edit-error').textContent = error.message || String(error); return; }

      $('edit-ok').textContent = 'Salvato.';
      await loadTavoli();
      $('edit-dialog').close();
    });

    // ----- Crea Tavolo -----
    function openCreate(){
      if (!IS_ADMIN){ alert('Solo admin.'); return; }
      $('create-error').textContent = '';
      $('create-ok').textContent = '';
      $('title').value = '';
      $('description').value = '';
      $('starts_at').value = '';
      $('duration_minutes').value = 60;
      $('max_seats').value = 4;
      $('complexity_label').value = 'medio';
      $('image_url').value = '';
      $('tags').value = '';
      $('create-dialog').showModal();
    }

    $('create-form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      if (!IS_ADMIN) return alert('Solo admin.');
      $('create-error').textContent = '';
      $('create-ok').textContent = '';

      const title = $('title').value.trim();
      const description = $('description').value.trim();
      const starts_local = $('starts_at').value;
      const duration = parseInt($('duration_minutes').value, 10);
      const max_seats = parseInt($('max_seats').value, 10);
      const complexity_label = $('complexity_label').value || 'medio';
      const image_url = $('image_url').value.trim();
      const tags = $('tags').value.split(',').map(s=>s.trim()).filter(Boolean);

      if (!title){ $('create-error').textContent = 'Nome tavolo richiesto.'; return; }
      if (!description){ $('create-error').textContent = 'Descrizione richiesta.'; return; }
      const dt = parseFutureLocalDateTime(starts_local);
      if (!dt.ok){ $('create-error').textContent = dt.error; return; }
      if (!Number.isFinite(duration) || duration < 1){ $('create-error').textContent = 'Durata non valida.'; return; }
      if (!Number.isFinite(max_seats) || max_seats < 1){ $('create-error').textContent = 'Posti massimi non validi.'; return; }

      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ $('create-error').textContent = 'Sessione non valida.'; return; }

      const payload = {
        title,
        description,
        starts_at: dt.value,
        duration_minutes: duration,
        max_seats,
        complexity_label,
        image_url: image_url || null,
        creator_id: user.id,
        tags
      };

      const { error } = await supabase.from('tavoli').insert(payload);
      if (error){ $('create-error').textContent = error.message || String(error); return; }

      $('create-ok').textContent = 'Creato.';
      await loadTavoli();
      $('create-dialog').close();
    });

    // ---------- Auth bootstrap ----------
    (async ()=>{
      $('env-ok').textContent = (typeof SUPABASE_URL==='string' && typeof SUPABASE_ANON_KEY==='string') ? 'ok' : 'err';
      $('sdk-ok').textContent = window.supabase ? 'ok' : 'err';

      const { data: { session } } = await supabase.auth.getSession();
      if (session){
        $('whoami').textContent = 'Utente: ' + (session.user.email || session.user.id);
        $('auth-ok').textContent = 'on';
        await loadRole();
        await loadTavoli();
      } else {
        renderAuth(false);
      }

      $('btn-login').addEventListener('click', async ()=>{
        const email = prompt('Inserisci email per magic link:');
        if (!email) return;
        const { error } = await supabase.auth.signInWithOtp({ email });
        if (error) alert('Errore login: ' + (error.message || ''));
        else alert('Controlla la tua email per completare il login.');
      });

      $('btn-logout').addEventListener('click', async ()=>{
        await supabase.auth.signOut();
        IS_ADMIN = false;
        $('role').textContent = 'Ruolo: —';
        renderAuth(false);
      });

      $('btn-open-mine').addEventListener('click', async ()=>{
        await loadMine();
        $('mine-dialog').showModal();
      });

      $('btn-open-create').addEventListener('click', openCreate);
      $('btn-refresh')?.addEventListener('click', loadTavoli);

      supabase.auth.onAuthStateChange(async (_e, s) => {
        if (s){
          $('whoami').textContent = 'Utente: ' + (s.user.email || s.user.id);
          $('auth-ok').textContent = 'on';
          await loadRole();
          await loadTavoli();
        } else {
          $('whoami').textContent = 'Utente: —';
          $('auth-ok').textContent = 'off';
          IS_ADMIN = false;
          $('role').textContent = 'Ruolo: —';
          renderAuth(false);
        }
      });
    })();

    async function loadRole(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ IS_ADMIN=false; $('role').textContent='Ruolo: —'; return; }
      // Ensure profile row exists then read role
      await supabase.from('profiles').upsert({ id: user.id }, { onConflict: 'id' }).select().maybeSingle();
      const { data } = await supabase.from('profiles').select('role').eq('id', user.id).maybeSingle();
      const role = data?.role || 'user';
      IS_ADMIN = role === 'admin';
      $('role').textContent = 'Ruolo: ' + role;
      renderAuth(true);
    }
  </script>
</body>
</html>
