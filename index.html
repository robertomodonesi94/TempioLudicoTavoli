<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tempio Ludico tavoli</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet" />

  <!-- üåü CONFIGURAZIONE APP -->
  <script>
    window.env = {
      SUPABASE_URL: "https://ekijcvhrvkpgncfyemwu.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVraWpjdmhydmtwZ25jZnllbXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDQyMDMsImV4cCI6MjA3MzIyMDIwM30.4zSq2FwHbwT13OcXmNbMI6beFaKq0r6j6pmzqlCV1xk",
      PRIVACY_URL: "/privacy.pdf"
    };
  </script>

  <!-- Supabase client -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    :root{--red:#d61e2b;--red-600:#b31620;--white:#fff;--bg:#fff6f6;--ink:#1a1a1a;--muted:#777}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Nunito,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;background:linear-gradient(90deg,var(--red),#ff4d5a);color:var(--white);padding:14px 16px;z-index:10;box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px}
    .heart{width:26px;height:26px;border-radius:8px;background:var(--white);display:grid;place-items:center;color:var(--red);box-shadow:0 2px 6px rgba(0,0,0,.15)}
    main{max-width:980px;margin:24px auto;padding:0 16px 80px}
    .card{background:#fff;border:1px solid #f0d6d8;border-radius:18px;box-shadow:0 8px 24px rgba(214,30,43,.08);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1 1 240px}
    input,select,button,textarea{font-family:inherit;font-size:15px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e7c2c5;background:#fff}
    textarea{min-height:90px}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s transform,.15s opacity}
    .btn{background:var(--red);color:#fff}
    .btn:hover{transform:translateY(-1px);opacity:.95}
    .btn-ghost{background:#fff;color:var(--red);border:1px solid #f0d6d8}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:18px 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #f0d6d8;background:#fff;color:var(--red);font-weight:700;cursor:pointer}
    .tab.active{background:var(--red);color:#fff;border-color:var(--red)}
    .list{display:grid;gap:12px}
    .tile{display:flex;gap:14px;align-items:center;border:1px solid #f0d6d8;padding:12px;border-radius:14px;background:#fff}
    .tile img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:1px solid #eee}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #f0d6d8;background:#fff;color:#b31620;font-size:12px;font-weight:800}
    .danger{color:#b31620}
    .divider{height:1px;background:#f6dadd;margin:14px 0}
    .footer{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #f0d6d8;padding:12px 16px;display:flex;justify-content:center}
    .hint{font-size:13px;color:var(--muted)}
    .right{margin-left:auto}
    .hidden{display:none}
    .center{text-align:center}
    .avatar{width:28px;height:28px;border-radius:50%;background:#ffd7da;display:inline-grid;place-items:center;font-weight:800;color:var(--red)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="heart">üé≤</div>
      <div>Tempio Ludico tavoli</div>
      <div class="right" id="userBadge"></div>
    </div>
  </header>

  <main>
    <!-- Login -->
    <section id="loginCard" class="card">
      <h2>Benvenuto! üëã</h2>
      <p class="muted">Accedi scegliendo un <strong>username univoco</strong> (senza email n√© password).</p>
      <div class="row">
        <input class="grow" id="usernameInput" placeholder="Scegli il tuo username" maxlength="28" />
        <button class="btn" id="btnLogin">Entra</button>
      </div>
      <p class="hint">Se esiste gi√†, scegli un altro nome. Gli admin sono gestiti dal server.</p>
    </section>

    <!-- Tabs -->
    <nav class="tabs hidden" id="tabs">
      <button class="tab active" data-tab="tavoli">Tavoli</button>
      <button class="tab" data-tab="prenotazioni">Prenotazioni</button>
      <button class="tab" data-tab="privacy">Privacy</button>
      <button class="tab hidden" data-tab="utenti" id="tabUtenti">Utenti</button>
    </nav>

    <!-- Tavoli -->
    <section id="page-tavoli" class="hidden">
      <div class="card" id="createTableCard">
        <h3>Crea un tavolo</h3>
        <div class="row">
          <input class="grow" id="tNome" placeholder="Nome" />
          <select id="tCompl">
            <option value="molto semplice">molto semplice</option>
            <option value="semplice">semplice</option>
            <option value="medio" selected>medio</option>
            <option value="complesso">complesso</option>
            <option value="molto complesso">molto complesso</option>
          </select>
          <input type="number" id="tDur" min="15" step="15" value="120" placeholder="Durata (min)" />
        </div>
        <div class="row">
          <input type="date" id="tDate" />
          <input type="time" id="tTime" />
          <input type="number" id="tSeats" min="1" max="12" value="4" placeholder="Posti" />
        </div>
        <div class="row">
          <textarea id="tDesc" placeholder="Descrizione (facoltativa)"></textarea>
        </div>
        <div class="row">
          <button class="btn" id="btnCreateTable">Crea tavolo</button>
        </div>
        <p class="hint">Puoi eliminare i tavoli che hai creato. Gli admin possono modificare/eliminare qualsiasi tavolo e caricare un‚Äôimmagine.</p>
      </div>

      <div style="height:10px"></div>
      <div class="card">
        <div class="row" style="align-items:center">
          <h3 class="grow">Elenco tavoli</h3>
          <input id="search" placeholder="Cerca per nome‚Ä¶" style="max-width:260px" />
        </div>
        <div id="tablesList" class="list"></div>
      </div>
    </section>

    <!-- Prenotazioni -->
    <section id="page-prenotazioni" class="hidden">
      <div class="card">
        <h3>Le mie prenotazioni</h3>
        <div id="resList" class="list"></div>
      </div>
    </section>

    <!-- Privacy -->
    <section id="page-privacy" class="hidden">
      <div class="card">
        <h3>Privacy Policy</h3>
        <iframe id="privacyFrame" title="Privacy Policy" style="width:100%;height:70vh;border:1px solid #f0d6d8;border-radius:12px"></iframe>
      </div>
    </section>

    <!-- Utenti (solo admin) -->
    <section id="page-utenti" class="hidden">
      <div class="card">
        <h3>Gestione utenti</h3>
        <div id="usersList" class="list"></div>
      </div>
    </section>
  </main>

  <div class="footer">
    <span class="hint">Condividi l'app inviando il link: funziona online su Vercel. ‚ù§Ô∏è</span>
  </div>

  <!-- Main logic -->
  <script type="module">
    <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  // ----- Helpers -----
  const $ = sel => document.querySelector(sel)
  const el = (tag, props={}, children=[]) => {
    const n = document.createElement(tag)
    Object.entries(props).forEach(([k,v])=>{
      if (k === 'class') n.className = v
      else if (k === 'html') n.innerHTML = v
      else if (k.startsWith('on')) n.addEventListener(k.slice(2), v)
      else n.setAttribute(k, v)
    })
    children.forEach(c=> n.appendChild(c))
    return n
  }
  const fmtDateTime = (iso)=> new Date(iso).toLocaleString('it-IT', { dateStyle:'medium', timeStyle:'short' })

  // ----- Config check -----
  if (!window.env?.SUPABASE_URL || !window.env?.SUPABASE_ANON_KEY) {
    alert('Config mancante: imposta SUPABASE_URL e SUPABASE_ANON_KEY in window.env nel <head>.')
    throw new Error('Missing env config')
  }
  const supabase = createClient(window.env.SUPABASE_URL, window.env.SUPABASE_ANON_KEY)
  const privacyFrame = document.getElementById('privacyFrame')
  if (privacyFrame) privacyFrame.src = window.env.PRIVACY_URL || 'about:blank'

  // ----- Stato globale -----
  let session = null
  let profile = null
  let isAdmin = false

  // Admin flag from `admins` table
  async function refreshAdminFlag() {
    if (!session?.user?.id) { isAdmin = false; return }
    const { data, error } = await supabase
      .from('admins')
      .select('user_id')
      .eq('user_id', session.user.id)
      .maybeSingle()
    if (error) console.warn('admin flag error', error)
    isAdmin = !!data
  }

  // ----- Tabs -----
  const tabsNav = $('#tabs')
  if (tabsNav) {
    tabsNav.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab')
      if(!btn) return
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'))
      btn.classList.add('active')
      const tab = btn.dataset.tab
      document.querySelectorAll('[id^="page-"]').forEach(sec=>sec.classList.add('hidden'))
      $(`#page-${tab}`).classList.remove('hidden')
      if(tab==='tavoli') loadTables()
      if(tab==='prenotazioni') loadReservations()
      if(tab==='utenti') loadUsers()
    })
  }

  // ----- Auth + Profile -----
  async function ensureAuth(){
    try {
      const { data: { session: s } } = await supabase.auth.getSession()
      session = s
      if (!session) {
        const { data, error } = await supabase.auth.signInAnonymously()
        if (error) throw error
        session = data.session
      }
      await fetchProfile()
      await refreshAdminFlag()
      renderLogin()
    } catch (err) {
      console.error('Auth error', err)
      alert('Errore autenticazione. Verifica che Anonymous sign-ins sia abilitato in Supabase e che le chiavi siano corrette.')
    }
  }

  async function fetchProfile(){
    const { data, error } = await supabase.from('profiles')
      .select('*')
      .eq('id', session.user.id)
      .maybeSingle()
    if(error) console.error(error)
    profile = data
  }

  function renderLogin(){
    const badge = el('div', {}, [
      el('span', { class:'avatar' , html:(profile?.username||'?').slice(0,2).toUpperCase() }),
      el('span', { style:'margin-left:8px;font-weight:800' , html: profile?.username||'ospite' }),
      isAdmin ? el('span',{ class:'pill', style:'margin-left:8px' , html:'ADMIN'}) : el('span')
    ])
    $('#userBadge').innerHTML = ''
    $('#userBadge').appendChild(badge)

    if(profile?.username){
      $('#loginCard').classList.add('hidden')
      $('#tabs').classList.remove('hidden')
      $('#page-tavoli').classList.remove('hidden')
      loadTables()
      if(isAdmin) $('#tabUtenti').classList.remove('hidden')
    } else {
      $('#loginCard').classList.remove('hidden')
    }
  }

  async function handleLogin(){
    const username = ($('#usernameInput').value||'').trim()
    if(!username){ alert('Inserisci un username.'); return }
    const { error } = await supabase.from('profiles').insert({ id: session.user.id, username })
    if(error){
      if (error.code === '23505' || /duplicate/i.test(error.message)) {
        alert('Username gi√† in uso. Scegline un altro.')
        return
      }
      console.error('Insert profile error', error)
      alert('Errore creazione profilo. Controlla le policy RLS e le chiavi.')
      return
    }
    await fetchProfile()
    await refreshAdminFlag()
    renderLogin()
  }

  // Click + Enter per login
  $('#btnLogin')?.addEventListener('click', handleLogin)
  $('#usernameInput')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); handleLogin() }
  })

  // ----- Tavoli -----
  $('#btnCreateTable')?.addEventListener('click', async ()=>{
    try{
      const name = $('#tNome').value.trim()
      const desc = $('#tDesc').value.trim()
      const duration = parseInt($('#tDur').value||'0',10)
      const seats = parseInt($('#tSeats').value||'0',10)
      const compl = $('#tCompl').value
      const d = $('#tDate').value
      const t = $('#tTime').value
      if(!name || !d || !t || duration<=0 || seats<=0){ alert('Compila tutti i campi.'); return }
      const dt = new Date(`${d}T${t}:00`)
      if(dt < new Date()){ alert('La data/ora deve essere nel futuro.'); return }
      const { error } = await supabase.from('tables').insert({
        name, description: desc, duration_minutes: duration, starts_at: dt.toISOString(), seats, complexity: compl
      })
      if(error) throw error
      $('#tNome').value = ''; $('#tDesc').value=''
      loadTables()
    }catch(err){ console.error(err); alert('Errore creazione tavolo. Verifica RLS e trigger set_creator_id.'); }
  })

  async function loadTables(){
    const q = ($('#search').value||'').trim()
    let query = supabase.from('tables_view').select('*').order('starts_at', { ascending: true })
    if(q) query = query.ilike('name', `%${q}%`)
    const { data, error } = await query
    const wrap = $('#tablesList'); wrap.innerHTML=''
    if(error){ console.error(error); wrap.appendChild(el('div',{class:'muted',html:'Errore nel caricamento tavoli (controlla viste/RLS).'})); return }
    if(!data?.length){ wrap.appendChild(el('div',{class:'muted center',html:'Nessun tavolo trovato.'})); return }
    data.forEach(row=> wrap.appendChild(renderTableTile(row)))
  }

  function renderTableTile(row){
    const mine = row.creator_id === session.user.id
    const canAdmin = isAdmin
    const img = row.image_url ? el('img',{src:row.image_url,alt:'immagine tavolo'}) : el('div',{class:'avatar',style:'width:84px;height:84px;font-size:28px'},['üé≤'])
    const title = el('div',{html:`<strong>${row.name}</strong><br><span class="muted">${fmtDateTime(row.starts_at)} ‚Ä¢ ${row.duration_minutes} min ‚Ä¢ ${row.seats} posti ‚Ä¢ <span class="pill">${row.complexity}</span></span>`})
    const desc = el('div',{class:'muted',html: (row.description||'')})
    const by = el('div',{class:'muted',html:`Creato da <b>${row.creator_name||'utente'}</b> ‚Ä¢ Prenotati: <b>${row.reserved}/${row.seats}</b>`})

    const btnBook = el('button',{class:'btn'},[document.createTextNode('Prenota')])
    btnBook.onclick = ()=> reserveSeat(row.id)

    const btnUnbook = el('button',{class:'btn-ghost'},[document.createTextNode('Annulla')])
    btnUnbook.onclick = ()=> unreserveSeat(row.id)

    const btnDelMine = (mine||canAdmin) ? el('button',{class:'btn-ghost danger'},[document.createTextNode('Elimina')]) : null
    if(btnDelMine) btnDelMine.onclick = ()=> deleteTable(row.id)

    const adminEdit = (canAdmin) ? el('button',{class:'btn-ghost'},[document.createTextNode('Modifica/Immagine')]) : null
    if(adminEdit) adminEdit.onclick = ()=> adminEditTable(row)

    const actions = el('div',{class:'row'},[btnBook, btnUnbook, btnDelMine||el('span'), adminEdit||el('span')])

    return el('div',{class:'tile'},[
      img,
      el('div',{class:'grow'},[title, desc, by, el('div',{class:'divider'}), actions])
    ])
  }

  async function reserveSeat(tableId){
    const { error } = await supabase.from('reservations').insert({ table_id: tableId })
    if(error){ alert(error.message||'Errore prenotazione (controlla RLS/trigger).'); return }
    loadTables(); loadReservations()
  }
  async function unreserveSeat(tableId){
    const { error } = await supabase.from('reservations').delete().match({ table_id: tableId, user_id: session.user.id })
    if(error){ alert('Errore annullamento'); return }
    loadTables(); loadReservations()
  }
  async function deleteTable(tableId){
    if(!confirm('Eliminare il tavolo? Questa azione rimuove anche le prenotazioni.')) return
    const { error } = await supabase.from('tables').delete().eq('id', tableId)
    if(error){ alert('Operazione non autorizzata o errore.'); return }
    loadTables(); loadReservations()
  }

  async function adminEditTable(row){
    const name = prompt('Nome', row.name); if(name===null) return
    const description = prompt('Descrizione', row.description||''); if(description===null) return
    const { error } = await supabase.from('tables').update({ name, description }).eq('id', row.id)
    if(error){ alert('Errore salvataggio.'); return }
    // Immagine opzionale (solo admin)
    if(confirm('Vuoi caricare/aggiornare un\'immagine?')){
      const input = document.createElement('input'); input.type='file'; input.accept='image/*'
      input.onchange = async ()=>{
        const file = input.files[0]; if(!file) return
        const path = `tables/${row.id}-${Date.now()}.jpg`
        const { error: upErr } = await supabase.storage.from('images').upload(path, file, { upsert:true, contentType:file.type })
        if(upErr){ alert('Upload fallito.'); return }
        const { data:pub } = supabase.storage.from('images').getPublicUrl(path)
        await supabase.from('tables').update({ image_url: pub.publicUrl }).eq('id', row.id)
        loadTables()
      }
      input.click()
    } else {
      loadTables()
    }
  }

  // ----- Prenotazioni -----
  async function loadReservations(){
    const { data, error } = await supabase.from('my_reservations_view').select('*').order('starts_at',{ascending:true})
    const wrap = $('#resList'); wrap.innerHTML=''
    if(error){ console.error(error); wrap.appendChild(el('div',{class:'muted',html:'Errore nel caricamento prenotazioni (controlla viste/RLS).'})); return }
    if(!data?.length){ wrap.appendChild(el('div',{class:'muted center',html:'Nessuna prenotazione.'})); return }
    data.forEach(r=>{
      const node = el('div',{class:'tile'},[
        el('div',{class:'grow', html:`<strong>${r.name}</strong><br><span class="muted">${fmtDateTime(r.starts_at)} ‚Ä¢ ${r.duration_minutes} min</span>`}),
        el('button',{class:'btn-ghost'},[document.createTextNode('Elimina')])
      ])
      node.querySelector('button').onclick = async ()=>{
        const { error } = await supabase.from('reservations').delete().eq('id', r.reservation_id)
        if(error){ alert('Errore.'); return }
        loadReservations(); loadTables()
      }
      wrap.appendChild(node)
    })
  }

  // ----- Utenti (solo admin) -----
  async function loadUsers(){
    if (!isAdmin) { $('#usersList').innerHTML = '<div class="muted">Non autorizzato.</div>'; return }
    const { data, error } = await supabase.from('profiles_admin_view').select('*').order('created_at',{ascending:false})
    const wrap = $('#usersList'); wrap.innerHTML=''
    if(error){ console.error(error); wrap.appendChild(el('div',{class:'muted',html:'Errore nel caricamento utenti (solo admin).'})); return }
    data.forEach(u=>{
      const node = el('div',{class:'tile'},[
        el('div',{class:'avatar'},[document.createTextNode((u.username||'??').slice(0,2).toUpperCase())]),
        el('div',{class:'grow', html:`<strong>${u.username||'(senza nome)'}</strong><br><span class="muted">${u.id}</span>`}),
        el('button',{class:'btn-ghost'},[document.createTextNode(u.is_admin?'Rimuovi admin':'Rendi admin')]),
        el('button',{class:'btn-ghost danger'},[document.createTextNode('Elimina utente')])
      ])
      // Toggle admin uses the RPC that now writes admins table
      node.children[2].onclick = async ()=>{
        const { error } = await supabase.rpc('toggle_admin', { p_user_id: u.id })
        if(error){ alert('Operazione non autorizzata.'); return }
        await refreshAdminFlag()
        loadUsers()
      }
      node.children[3].onclick = async ()=>{
        if(!confirm('Eliminare utente e dati associati?')) return
        const { error } = await supabase.rpc('admin_delete_user', { p_user_id: u.id })
        if(error){ alert('Operazione non autorizzata.'); return }
        loadUsers(); loadTables(); loadReservations()
      }
      wrap.appendChild(node)
    })
  }

  // ----- Ricerca -----
  $('#search')?.addEventListener('input', ()=> loadTables())

  // ----- Avvio -----
  ensureAuth()
  </script>
</body>
</html>

