<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempio Ludico — Tavoli</title>
  <meta name="theme-color" content="#ed445b" />
  <style>
    :root{--bg:#ed445b;--ink:#0b0f14;--card:#fff;--muted:#5b6c85;--b:#e5e7eb;--b2:#d1d5db}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;color:#fff}
    h1{font-size:20px;margin:0}
    .badge{font-size:12px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:2px 8px}
    .grid{display:grid;gap:14px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px;color:var(--ink)}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--b2);border-radius:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1}
    button{border:1px solid var(--b2);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#f3f4f6}
    .btn-accent{background:#ed445b;color:#fff;border-color:#d73c52}
    .btn-danger{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--b);border-radius:10px;padding:12px;background:#fff}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .thumb{width:100%;height:160px;object-fit:cover;border-radius:8px;border:1px solid var(--b)}
    .noimg{height:160px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--b2);border-radius:8px;color:var(--muted);background:#fafafa}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tempio Ludico — Tavoli</h1>
      <div class="row" style="gap:6px;color:#fff">
        <span class="badge">env:<span id="env-ok">…</span></span>
        <span class="badge">sdk:<span id="sdk-ok">…</span></span>
        <span class="badge">auth:<span id="auth-ok">…</span></span>
      </div>
    </header>

    <section id="auth" class="card">
      <h2>Accesso</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btn-signup"  type="button" class="btn-accent">Registrati</button>
        <button id="btn-signin"  type="button">Entra</button>
        <button id="btn-signout" type="button" class="btn-danger">Esci</button>
        <button id="btn-anon"    type="button">Anon</button>
      </div>
      <div id="auth-log" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:6px">
        <div class="muted" id="whoami">Utente: —</div>
        <div class="muted" id="role">Ruolo: —</div>
      </div>
    </section>

    <div id="app" class="hidden" aria-hidden="true">
      <div class="grid">
        <section class="card">
          <h2>Profilo</h2>
          <label>Username</label>
          <input id="username" placeholder="handle (3–32)" />
          <div class="row" style="margin-top:10px">
            <button id="btn-save-profile" type="button" class="btn-accent">Salva profilo</button>
            <button id="btn-ping" type="button">Ping REST</button>
          </div>
          <div id="profile-log" class="muted" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h2>Crea tavolo</h2>
          <label>Titolo</label>
          <input id="title" placeholder="Nome sessione" />
          <div class="row">
            <div>
              <label>Complessità</label>
              <select id="complexity">
                <option value="1">1</option><option value="2">2</option>
                <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
              </select>
            </div>
            <div>
              <label>Immagine (opz.)</label>
              <input id="image_url" placeholder="https://…" />
            </div>
          </div>
          <div style="margin-top:10px">
            <button id="btn-create" type="button" class="btn-accent">Crea</button>
          </div>
          <div id="create-log" class="muted" style="margin-top:8px"></div>
        </section>
      </div>

      <section class="card" style="margin-top:14px">
        <div class="row" style="align-items:center">
          <h2 style="flex:1">Elenco tavoli</h2>
          <button id="btn-refresh" type="button">Aggiorna</button>
        </div>
        <div id="tables" class="list"></div>
        <div id="tables-log" class="muted"></div>
      </section>

      <section class="card" style="margin-top:14px">
        <h2>Le mie prenotazioni</h2>
        <div id="mine" class="list"></div>
      </section>
    </div>
  </div>

  <script src="/env.js"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const setBadge = (id, ok) => { const el=document.getElementById(id); if (el) el.textContent = ok ? 'OK' : 'err'; };
    setBadge('env-ok', !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY));
    setBadge('sdk-ok', true);

    const SB_OPTS = { auth: { storageKey: 'sb-tempioludico-web-v1', persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } };
    window.__supabase ??= createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, SB_OPTS);
    window.supabase = window.__supabase;

    window.__sbAuthSub?.unsubscribe?.();
    window.__sbAuthSub = supabase.auth.onAuthStateChange((event, session) => {
      console.log('auth:', event, session?.user?.id || null);
      renderAuth(!!session);
      if (session) bootData().catch(console.error);
    }).data.subscription;

    const $ = (id) => document.getElementById(id);
    const fmt = (d) => d ? new Date(d).toLocaleString() : '—';
    const log = (id, msg, cls='muted') => { const el=$(id); if(el){ el.className=cls; el.textContent=msg; } };

    function renderAuth(isAuthed){
      $('auth').classList.toggle('hidden', isAuthed);
      $('app').classList.toggle('hidden', !isAuthed);
      $('app').setAttribute('aria-hidden', String(!isAuthed));
      setBadge('auth-ok', isAuthed);
    }
    async function getSessionUser(){
      const { data: { session } } = await supabase.auth.getSession();
      return session?.user || null;
    }
    async function pingRest(){
      const s = await supabase.auth.getSession();
      const token = s?.data?.session?.access_token;
      if (!token) return { ok:false, reason:'no-session' };
      const url = `${window.SUPABASE_URL}/rest/v1/profiles?select=id&limit=1`;
      const res = await fetch(url, { headers: { apikey: window.SUPABASE_ANON_KEY, Authorization: `Bearer ${token}` } });
      return { ok: res.ok, status: res.status };
    }

    // AUTH
    async function signUp(){
      log('auth-log','');
      const email=$('email').value.trim(), password=$('password').value;
      if (!email || !password) return log('auth-log','Email and password required');
      const { error } = await supabase.auth.signUp({ email, password, options:{ emailRedirectTo: location.origin + '/' } });
      if (error) return log('auth-log', error.message || String(error));
      log('auth-log','Registered. Check email to confirm.');
    }
    async function signIn(){
      log('auth-log','');
      const email=$('email').value.trim(), password=$('password').value;
      if (!email || !password) return log('auth-log','Email and password required');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return log('auth-log', error.message || String(error));
      $('whoami').textContent = 'Utente: ' + (data.session.user.email || data.session.user.id);
      await bootData();
    }
    async function signInAnon(){
      const { data, error } = await supabase.auth.signInAnonymously();
      if (error) return log('auth-log', error.message || String(error));
      $('whoami').textContent = 'Utente: ' + data.user.id;
      await bootData();
    }
    async function signOut(){
      await supabase.auth.signOut();
      $('whoami').textContent = 'Utente: —'; $('role').textContent = 'Ruolo: —';
      $('tables').innerHTML = ''; $('mine').innerHTML = '';
      log('auth-log','Signed out');
    }

    // PROFILE
    async function loadProfile(){
      const user = await getSessionUser(); if (!user) return;
      const { data, error } = await supabase
        .from('profiles')
        .select('username,role')
        .eq('id', user.id)
        .maybeSingle();
      if (error) return;
      $('username').value = data?.username ?? '';
      $('role').textContent = 'Ruolo: ' + (data?.role || 'user');
      $('whoami').textContent = 'Utente: ' + (user.email || user.id);
    }
    async function saveProfile(){
      await pingRest();
      const user = await getSessionUser(); if (!user) return log('profile-log','Login required');
      const username = $('username').value.trim() || null;
      const { error } = await supabase.from('profiles').upsert({ id: user.id, username }, { onConflict: 'id' });
      if (error) return log('profile-log', error.message || String(error));
      await loadProfile();
      log('profile-log','Profile saved');
    }

    // DATA — no view, no duplicates
    function renderTableItem(t){
      return `
        ${t.image_url ? `<img class="thumb" src="${t.image_url}" alt="${t.title}" />` : `<div class="noimg">No image</div>`}
        <h3 style="margin:8px 0 6px 0">${t.title}</h3>
        <div class="meta"><span>Complexity: ${t.complexity}</span><span>Created: ${fmt(t.created_at)}</span><span>Bookings: ${t.reservations_count}</span></div>
        <div class="row" style="margin-top:8px"><button class="btn-accent" data-act="reserve" data-id="${t.id}" type="button">Prenota</button></div>
      `;
    }

    async function fetchTavoli(){
      const { data, error } = await supabase
        .from('tavoli')
        .select('id,title,complexity,image_url,created_at')
        .order('created_at',{ascending:false})
        .limit(200);
      if (error) throw error;
      return data || [];
    }
    async function fetchReservationCounts(){
      // pull only ids and count client-side to avoid duplication
      const { data, error } = await supabase
        .from('reservations')
        .select('tavolo_id'); // RLS should already scope to user if needed, else returns all
      if (error) throw error;
      const m = new Map();
      for (const r of (data || [])) m.set(r.tavolo_id, (m.get(r.tavolo_id) || 0) + 1);
      return m;
    }
    async function listTavoliWithCounts(){
      const [tavoli, counts] = await Promise.all([fetchTavoli(), fetchReservationCounts()]);
      // ensure uniqueness by id
      const seen = new Set();
      return tavoli.filter(t => !seen.has(t.id) && seen.add(t.id))
                   .map(t => ({ ...t, reservations_count: counts.get(t.id) || 0 }));
    }

    async function createTavolo(){
      await pingRest();
      const title=$('title').value.trim(); const complexity=Number($('complexity').value); const image_url=$('image_url').value.trim();
      if (!title) return log('create-log','Title required');
      if (!Number.isFinite(complexity) || complexity<1 || complexity>5) return log('create-log','Complexity 1–5');
      const payload = { title, complexity }; if (image_url) payload.image_url = image_url;
      const { error } = await supabase.from('tavoli').insert(payload);
      if (error) return log('create-log', error.message || String(error));
      $('title').value=''; $('image_url').value=''; $('complexity').value='3';
      log('create-log','Table created');
      await loadTavoli(); await loadMine();
    }

    async function loadTavoli(){
      const host = $('tables'); host.innerHTML='';
      try{
        const items = await listTavoliWithCounts();
        for (const t of items){
          const el = document.createElement('div');
          el.className = 'item';
          el.innerHTML = renderTableItem(t);
          el.querySelector('[data-act="reserve"]').addEventListener('click', async (ev)=>{
            ev.preventDefault();
            await pingRest();
            try{ await supabase.from('reservations').insert({ tavolo_id: t.id }); await loadTavoli(); await loadMine(); }
            catch(err){ alert('Errore: ' + (err?.message || err)); }
          });
          host.appendChild(el);
        }
        if (!items.length) host.innerHTML = '<div class="muted">Nessun tavolo</div>';
        log('tables-log', `${items.length} tavoli`);
      }catch(e){ log('tables-log', e.message || String(e)); }
    }

    async function deleteReservation(id){
      await pingRest();
      const { error } = await supabase.from('reservations').delete().eq('id', id);
      if (error) throw error;
    }
    async function loadMine(){
      const host=$('mine'); host.innerHTML='';
      const { data, error } = await supabase
        .from('reservations')
        .select('id,tavolo_id,created_at')
        .order('created_at',{ascending:false});
      if (error){ host.innerHTML=''; return; }
      if (!data?.length){ host.innerHTML = '<div class="muted">Nessuna prenotazione</div>'; return; }

      const ids=[...new Set(data.map(r=>r.tavolo_id))];
      const t = await supabase.from('tavoli').select('id,title').in('id', ids);

      for (const r of data){
        const tt = t.data?.find(x=>x.id===r.tavolo_id);
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <h3 style="margin:0 0 6px 0">${tt?tt.title:r.tavolo_id}</h3>
          <div class="meta"><span>Prenotato: ${fmt(r.created_at)}</span></div>
          <div class="row" style="margin-top:8px">
            <button class="btn-danger" data-act="cancel" data-id="${r.id}" type="button">Cancella</button>
          </div>`;
        el.querySelector('[data-act="cancel"]').addEventListener('click', async (ev)=>{
          ev.preventDefault();
          try { await deleteReservation(r.id); await loadMine(); }
          catch (err) { alert('Errore cancellazione: ' + (err?.message || err)); }
        });
        host.appendChild(el);
      }
    }

    async function bootData(){
      await loadProfile();
      await loadTavoli();
      await loadMine();
    }

    function bind(){
      const map = new Map([
        ['btn-signup',        signUp],
        ['btn-signin',        signIn],
        ['btn-anon',          signInAnon],
        ['btn-signout',       signOut],
        ['btn-save-profile',  saveProfile],
        ['btn-ping',          async ()=>{ const r=await pingRest(); alert('Ping ' + JSON.stringify(r)); }],
        ['btn-create',        createTavolo],
        ['btn-refresh',       async ()=>{ await pingRest(); await loadTavoli(); await loadMine(); }]
      ]);
      for (const [id,fn] of map){
        const el=$(id); if (!el) continue;
        el.onclick = null;
        el.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await fn(); }catch(err){ console.error(id, err); } });
      }
    }

    (async ()=>{
      bind();
      const { data: { session} } = await supabase.auth.getSession();
      renderAuth(!!session);
      if (session) await bootData();
      if (session) $('whoami').textContent = 'Utente: ' + (session.user.email || session.user.id);
    })();
  </script>
</body>
</html>
