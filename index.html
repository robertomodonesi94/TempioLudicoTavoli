<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tempio Ludico Tavoli</title>
  <meta name="description" content="Crea tavoli da gioco e prenota un posto." />
  <style>
    :root { --bg:#0b0f14; --card:#121821; --muted:#9fb0c9; --text:#e8eef6; --accent:#5fb3ff; --danger:#ff6b6b; --ok:#86efac; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    a { color: var(--accent); text-decoration: none; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 24px; }
    h1 { font-size: 22px; margin: 0; }
    .badge { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; background: #1b2532; color: var(--muted); border: 1px solid #223046; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--card); border: 1px solid #1a2433; border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(0,0,0,.2); }
    .card h2 { margin-top:0; font-size: 16px; }
    label { display:block; font-size: 13px; color: var(--muted); margin: 10px 0 6px; }
    input, select { width: 100%; background: #0e141d; color: var(--text); border:1px solid #223046; border-radius: 8px; padding: 10px 12px; font-size: 14px; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex:1; }
    .row .shrink { flex: 0 0 auto; }
    button { background: #172233; color: var(--text); border: 1px solid #233248; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 600; }
    button:hover { border-color: #31507b; }
    .btn-accent { background: #143250; border-color:#2c6fb6; }
    .btn-danger { background: #3b1b1b; border-color:#7a2e2e; }
    .muted { color: var(--muted); }
    .ok { color: var(--ok); }
    .err { color: var(--danger); }
    .list { display:flex; flex-direction: column; gap:10px; margin-top: 10px; }
    .item { border:1px solid #203049; border-radius: 10px; padding: 12px; background:#0e141d; }
    .item h3 { margin: 0 0 8px 0; font-size: 15px; }
    .item .meta { font-size: 12px; color: var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .item .actions { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; }
    code.inline { background: #0c121a; border: 1px solid #1c2839; border-radius: 6px; padding: 2px 6px; }
    footer { margin-top: 28px; font-size: 12px; color: var(--muted); }
    img.thumb { width:100%; height:160px; object-fit:cover; border-radius:8px; border:1px solid #1f2937; }
    .noimg { height:160px; display:flex; align-items:center; justify-content:center; border:1px dashed #243244; border-radius:8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Tempio Ludico Tavoli</h1>
      <div>
        <span id="env-badge" class="badge">env.js: <span id="env-status">…</span></span>
        <span id="sdk-badge" class="badge">supabase-js: <span id="sdk-status">…</span></span>
        <span id="auth-badge" class="badge">auth: <span id="auth-status">…</span></span>
      </div>
    </header>

    <div class="grid">
      <!-- Auth & Profile -->
      <section class="card">
        <h2>Accesso & Profilo</h2>
        <div class="muted" id="whoami">Utente: —</div>
        <div class="row" style="margin-top:10px;">
          <button id="btn-anon" class="btn-accent">Accedi anonimamente</button>
          <button id="btn-signout">Esci</button>
        </div>

        <label for="username">Username (univoco)</label>
        <div class="row">
          <input id="username" placeholder="es. gamer_ale" />
          <button id="btn-save-username" class="shrink">Salva</button>
        </div>
        <div class="muted" id="admin-flag">Ruolo: utente</div>

        <div style="margin-top:10px;">
          <button id="btn-copy-id">Copia il mio user_id</button>
        </div>

        <div id="auth-log" class="muted"></div>
      </section>

      <!-- Create Tavolo -->
      <section class="card">
        <h2>Crea un tavolo</h2>
        <label for="title">Titolo</label>
        <input id="title" placeholder="Nome del gioco / sessione" />

        <div class="row">
          <div>
            <label for="complexity">Complessità</label>
            <select id="complexity">
              <option value="1">1 (molto semplice)</option>
              <option value="2">2 (semplice)</option>
              <option value="3" selected>3 (medio)</option>
              <option value="4">4 (complesso)</option>
              <option value="5">5 (molto complesso)</option>
            </select>
          </div>
          <div>
            <label for="image_url">URL immagine (opzionale)</label>
            <input id="image_url" placeholder="URL pubblico (es. bucket 'tavoli' pubblico)" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <button id="btn-create" class="btn-accent">Crea tavolo</button>
        </div>
        <div id="create-log" class="muted"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px;">
      <div class="row" style="align-items:center;">
        <h2 style="flex:1;">Elenco tavoli</h2>
        <button id="btn-refresh" class="shrink">Aggiorna</button>
      </div>
      <div id="tables" class="list"></div>
      <div id="tables-log" class="muted"></div>
    </section>

    <section class="card" style="margin-top:16px;">
      <h2>Le mie prenotazioni</h2>
      <div id="mine" class="list"></div>
    </section>

    <footer>
      <p>Debug rapido: apri la console e prova <code class="inline">await window.supabase.auth.getUser()</code>.</p>
    </footer>
  </div>

  <!-- 1) Variabili pubbliche; deve definire window.SUPABASE_URL e window.SUPABASE_ANON_KEY -->
  <script src="/env.js"></script>

  <!-- 2) App + Supabase via ES Module -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ---- Guard per env ----
    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
      throw new Error("Missing SUPABASE_URL o SUPABASE_ANON_KEY da /env.js");
    }

    // ---- Singleton Supabase client ----
    window.supabase = window.supabase ?? createClient(
      window.SUPABASE_URL,
      window.SUPABASE_ANON_KEY,
      { auth: { storageKey: "sb-tempioludico", autoRefreshToken: true, persistSession: true, detectSessionInUrl: true } }
    );

    // ---- Badge stato ----
    document.getElementById('env-status').textContent = 'OK';
    document.getElementById('env-badge').style.borderColor = '#2c6fb6';
    document.getElementById('sdk-status').textContent = 'OK';
    document.getElementById('sdk-badge').style.borderColor = '#2c6fb6';

    // === Helpers ===
    const $ = (id) => document.getElementById(id);
    const fmt = (d) => d ? new Date(d).toLocaleString() : '—';

    function showError(elId, err) {
      const el = $(elId);
      el.className = 'err';
      el.textContent = (err && err.message) ? err.message : String(err);
    }
    function showOk(elId, msg) {
      const el = $(elId);
      el.className = 'ok';
      el.textContent = msg;
    }

    // === Auth/session ===
    async function ensureSession() {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (!session) {
        const { error } = await window.supabase.auth.signInAnonymously();
        if (error) throw error;
      }
    }

    async function refreshAuthUI() {
      const { data: { user } } = await window.supabase.auth.getUser();
      const el = $('whoami');
      const authStatus = $('auth-status');

      if (!user) {
        el.textContent = 'Utente: —';
        authStatus.textContent = 'non autenticato';
        $('auth-badge').style.borderColor = '#7a2e2e';
        return;
      }
      authStatus.textContent = 'OK';
      $('auth-badge').style.borderColor = '#2c6fb6';
      el.textContent = `Utente: ${user.id}`;

      // carica profilo (id == auth.users.id)
      const { data, error } = await window.supabase
        .from('profiles')
        .select('username, role')
        .eq('id', user.id)
        .maybeSingle();

      if (!error && data) {
        if (data.username) $('username').value = data.username;
        const isAdmin = data.role === 'admin';
        $('admin-flag').textContent = `Ruolo: ${isAdmin ? 'admin' : 'utente'}`;
        $('admin-flag').className = isAdmin ? 'ok' : 'muted';
      } else {
        $('admin-flag').textContent = 'Ruolo: utente';
        $('admin-flag').className = 'muted';
      }
    }

    async function saveUsername() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return showError('auth-log', 'Nessuna sessione utente.');
      const username = $('username').value.trim();
      if (!/^[a-zA-Z0-9_-]{3,32}$/.test(username)) return showError('auth-log', 'Username non valido (3–32, alfanumerico/_-).');

      // Usa RPC che lega id = auth.uid() e gestisce unique/UPSERT
      const { error } = await window.supabase.rpc('set_username', { new_username: username });
      if (error) {
        if (error.code === '23505') return showError('auth-log', 'Username già in uso.');
        return showError('auth-log', error);
      }
      showOk('auth-log', 'Username salvato.');
      refreshAuthUI();
    }

    // === Tavoli & Prenotazioni ===
    async function createTavolo() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return showError('create-log', 'Nessuna sessione utente.');

      const title = $('title').value.trim();
      const complexity = Number($('complexity').value);
      const image_url = $('image_url').value.trim();

      if (!title) return showError('create-log', 'Titolo obbligatorio.');
      if (Number.isNaN(complexity) || complexity < 1 || complexity > 5) return showError('create-log', 'Complessità 1–5.');

      // Trigger set_creator_id() imposta creator_id = auth.uid()
      const insert = { title, complexity };
      if (image_url) insert.image_url = image_url;

      const { error } = await window.supabase.from('tavoli').insert(insert);
      if (error) return showError('create-log', error);

      showOk('create-log', 'Tavolo creato.');
      $('title').value = '';
      $('image_url').value = '';
      $('complexity').value = '3';
      await loadTavoli();
    }

    async function reserve(tavoloId) {
      // Trigger set_res_user() imposta user_id = auth.uid()
      const { error } = await window.supabase
        .from('reservations')
        .insert({ tavolo_id: tavoloId });
      if (error) throw error;
    }

    async function loadTavoli() {
      const list = $('tables');
      list.innerHTML = '';
      const { data, error } = await window.supabase
        .from('tavoli_view')
        .select('id,title,complexity,image_url,created_at,reservations_count')
        .order('created_at', { ascending: false })
        .limit(100);

      if (error) { showError('tables-log', error); return; }
      showOk('tables-log', `${data.length} tavoli.`);

      for (const t of data) {
        const item = document.createElement('div');
        item.className = 'item';

        const img = t.image_url
          ? `<img class="thumb" src="${t.image_url}" alt="${t.title}">`
          : `<div class="noimg muted">Nessuna immagine</div>`;

        item.innerHTML = `
          ${img}
          <h3 style="margin-top:8px;">${t.title}</h3>
          <div class="meta">
            <span>Complessità: ${t.complexity}</span>
            <span>Prenotazioni: ${t.reservations_count ?? 0}</span>
            <span>Creato: ${fmt(t.created_at)}</span>
          </div>
          <div class="actions">
            <button data-act="reserve">Prenota</button>
          </div>
        `;
        item.querySelector('[data-act="reserve"]').onclick = async () => {
          try {
            await reserve(t.id);
            await loadTavoli();
            await loadMine();
          } catch (e) {
            alert('Errore prenotazione: ' + (e.message || e));
          }
        };
        list.appendChild(item);
      }

      if (data.length === 0) {
        list.innerHTML = '<div class="muted">Nessun tavolo creato.</div>';
      }
    }

    async function loadMine() {
      const host = $('mine');
      host.innerHTML = '';
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return;

      // Le policy permettono di leggere SOLO le proprie prenotazioni
      const { data: myRes, error } = await window.supabase
        .from('reservations')
        .select('tavolo_id, created_at')
        .order('created_at', { ascending:false });

      if (error) return;

      if (!myRes.length) { host.innerHTML = '<div class="muted">Nessuna prenotazione.</div>'; return; }

      const ids = myRes.map(r => r.tavolo_id);
      const { data: tavoli } = await window.supabase
        .from('tavoli')
        .select('id,title')
        .in('id', ids);

      for (const r of myRes) {
        const t = tavoli.find(x => x.id === r.tavolo_id);
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <h3>${t ? t.title : r.tavolo_id}</h3>
          <div class="meta">
            <span>Prenotato: ${fmt(r.created_at)}</span>
          </div>
          <div class="actions">
            <button class="btn-danger" data-act="cancel">Annulla</button>
          </div>
        `;
        div.querySelector('[data-act="cancel"]').onclick = async () => {
          // Le policy consentono di eliminare SOLO le proprie righe
          await window.supabase
            .from('reservations')
            .delete()
            .eq('tavolo_id', r.tavolo_id);
          await loadTavoli();
          await loadMine();
        };
        host.appendChild(div);
      }
    }

    // === Event bindings ===
    $('btn-anon').onclick = async () => {
      try {
        await window.supabase.auth.signInAnonymously();
        await refreshAuthUI();
        await loadTavoli();
        await loadMine();
      } catch (e) { showError('auth-log', e); }
    };

    $('btn-signout').onclick = async () => {
      await window.supabase.auth.signOut();
      await refreshAuthUI();
      $('tables').innerHTML = '';
      $('mine').innerHTML = '';
    };

    $('btn-save-username').onclick = async () => {
      try {
        await ensureSession();
        await saveUsername();
      } catch (e) {
        showError('auth-log', e);
      }
    };

    $('btn-create').onclick = async () => {
      try {
        await ensureSession();
        await createTavolo();
      } catch (e) {
        showError('create-log', e);
      }
    };

    $('btn-refresh').onclick = async () => { await loadTavoli(); await loadMine(); };
    $('btn-copy-id').onclick = async () => {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user) return;
      await navigator.clipboard.writeText(user.id);
      alert('User ID copiato negli appunti:\n' + user.id);
    };

    // === Boot ===
    try {
      await ensureSession();
      await refreshAuthUI();
      await loadTavoli();
      await loadMine();
    } catch (e) {
      showError('auth-log', e);
    }
  </script>
</body>
</html>
