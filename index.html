<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempio Ludico — Tavoli</title>
  <meta name="theme-color" content="#ed445b" />
  <style>
    :root{--bg:#ed445b;--ink:#0b0f14;--card:#fff;--muted:#5b6c85;--b:#e5e7eb;--b2:#d1d5db}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;color:#fff}
    h1{font-size:20px;margin:0}
    .badge{font-size:12px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:2px 8px}
    .grid{display:grid;gap:14px}
    @media (min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid var(--b);border-radius:12px;padding:14px}
    .card h2{margin:0 0 8px 0;font-size:16px;color:var(--ink)}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--b2);border-radius:8px}
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1}
    button{border:1px solid var(--b2);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#f3f4f6}
    .btn-accent{background:#ed445b;color:#fff;border-color:#d73c52}
    .btn-danger{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
    .muted{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{border:1px solid var(--b);border-radius:10px;padding:12px;background:#fff}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .thumb{width:100%;height:160px;object-fit:cover;border-radius:8px;border:1px solid var(--b)}
    .noimg{height:160px;display:flex;align-items:center;justify-content:center;border:1px dashed var(--b2);border-radius:8px;color:#6b7280;background:#fafafa}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .tag{font-size:12px;border:1px solid var(--b2);border-radius:999px;padding:2px 8px;background:#f9fafb}
    .hidden{display:none}
    .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:700px){.cols-2{grid-template-columns:1fr}}
    dialog{border:none;border-radius:12px;max-width:640px;width:90vw;padding:0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .dlg-head{padding:14px 16px;border-bottom:1px solid var(--b);font-weight:700}
    .dlg-body{padding:12px 16px;max-height:60vh;overflow:auto}
    .dlg-foot{padding:12px 16px;border-top:1px solid var(--b);display:flex;gap:8px;justify-content:flex-end}
    .checklist{display:flex;flex-wrap:wrap;gap:8px}
    .checklist label{display:flex;align-items:center;gap:6px;border:1px solid var(--b2);padding:8px 10px;border-radius:12px;background:#fafafa}
    .checklist input{width:16px;height:16px}
    .tags-summary{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .tags-summary .tag{border:1px solid var(--b2);padding:4px 8px;border-radius:999px;background:#fff;font-size:12px;margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Tempio Ludico — Tavoli</h1>
      <div class="badges">
        <span class="badge">env: <span id="env-ok">—</span></span>
        <span class="badge">sdk: <span id="sdk-ok">—</span></span>
        <span class="badge">auth: <span id="auth-ok">—</span></span>
      </div>
    </header>

    <!-- AUTH -->
    <section class="card">
      <h2>Accesso</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btn-signup"  type="button" class="btn-accent">Registrati</button>
        <button id="btn-signin"  type="button">Entra</button>
        <button id="btn-signout" type="button" class="btn-danger">Esci</button>
        <button id="btn-anon"    type="button">Anon</button>
      </div>
      <div id="auth-log" class="muted" style="margin-top:8px"></div>
      <div class="row" style="margin-top:6px">
        <div class="muted" id="whoami">Utente: —</div>
        <div class="muted" id="role">Ruolo: —</div>
      </div>
    </section>

    <!-- APP -->
    <div id="app" class="hidden" aria-hidden="true">
      <div class="grid">
        <section class="card">
          <h2>Profilo</h2>
          <label>Username</label>
          <input id="username" type="text" placeholder="handle (3–32)" />
          <div class="row" style="margin-top:10px">
            <button id="btn-save-profile" type="button" class="btn-accent">Salva profilo</button>
            <!-- Shown only for SUPER_UID and when not admin yet -->
            <button id="btn-become-admin" type="button" class="btn-danger hidden">Diventa admin</button>
          </div>
          <div id="profile-log" class="muted" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h2>Crea tavolo</h2>

          <label>Titolo</label>
          <input id="title" type="text" placeholder="Nome del gioco" />

          <label>Descrizione</label>
          <textarea id="description" placeholder="Dettagli, regolamento, durata, requisiti..."></textarea>

          <div class="cols-2">
            <div>
              <label>Data e ora</label>
              <input id="starts_at" type="datetime-local" />
            </div>
            <div>
              <label>Posti disponibili</label>
              <input id="max_seats" type="number" min="1" max="20" />
            </div>
          </div>

          <div class="cols-2">
            <div>
              <label>Complessità</label>
              <select id="complexity_label">
                <option value="molto semplice">Molto semplice</option>
                <option value="semplice">Semplice</option>
                <option value="medio" selected>Medio</option>
                <option value="complesso">Complesso</option>
                <option value="molto complesso">Molto complesso</option>
              </select>
            </div>
            <div>
              <label>Immagine (URL)</label>
              <input id="image_url" type="url" placeholder="https://..." />
            </div>
          </div>

          <label>Tag</label>
          <div class="tags-summary">
            <button id="btn-tags" type="button">Seleziona tag…</button>
            <div id="tags-summary"></div>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btn-create" type="button" class="btn-accent">Crea</button>
            <button id="btn-refresh" type="button">Aggiorna</button>
          </div>
          <div id="create-log" class="muted" style="margin-top:8px"></div>
        </section>

        <section class="card">
          <h2>Tutti i tavoli</h2>
          <div id="tables-log" class="muted" style="margin-bottom:6px"></div>
          <div id="tables" class="list"></div>
        </section>

        <section class="card">
          <h2>I miei tavoli</h2>
          <div id="mine" class="list"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- TAG PICKER MODAL -->
  <dialog id="tags-dialog">
    <div class="dlg-head">Seleziona tag</div>
    <div class="dlg-body">
      <div id="tags-list" class="checklist"></div>
    </div>
    <div class="dlg-foot">
      <button type="button" id="tags-cancel">Annulla</button>
      <button type="button" id="tags-apply" class="btn-accent">Applica</button>
    </div>
  </dialog>

  <script src="/env.js"></script>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // constants
    const SUPER_UID = '8f966e17-8d57-4917-9e10-3296a8fbd604';

    // badges
    const setBadge = (id, ok) => { const el=document.getElementById(id); if (el) el.textContent = ok ? 'OK' : 'err'; };
    setBadge('env-ok', !!(window.SUPABASE_URL && window.SUPABASE_ANON_KEY));
    setBadge('sdk-ok', true);

    // supabase singleton
    const SB_OPTS = { auth: { storageKey: 'sb-tempioludico-web-v1', persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } };
    window.__supabase ??= createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, SB_OPTS);
    const supabase = window.__supabase;

    // dom helpers
    const $ = (id)=>document.getElementById(id);
    const log = (id, text)=>{ const el=$(id); if (el) el.textContent = text || ''; };
    const fmtDate = (iso)=> new Date(iso).toLocaleString('it-IT', { dateStyle:'short', timeStyle:'short' });

    // tags
    const ALL_TAGS = [
      'worker-placement','deck-building','engine-building','tableau-building','area-control','drafting','set-collection','tile-laying','push-your-luck','trick-taking','dexterity','action-selection','negotiation','auction','memory','roll-and-write','roll-and-move','cooperative','semi-cooperative','competitive','team-based','traitor','hidden-roles','social-deduction','take-that','low-interaction'
    ];
    let SELECTED_TAGS = [];

    function renderTagsSummary(){
      const box = $('tags-summary'); box.innerHTML='';
      for (const t of SELECTED_TAGS){
        const s = document.createElement('span'); s.className='tag'; s.textContent=t; box.appendChild(s);
      }
      if (!SELECTED_TAGS.length){ const s=document.createElement('span'); s.className='muted'; s.textContent='Nessun tag'; box.appendChild(s); }
    }

    async function loadProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return log('profile-log','Login richiesto');
      // ensure profile row
      await supabase.from('profiles').upsert({ id: user.id }).select().single().catch(()=>null);
      const { data, error } = await supabase.from('profiles').select('username,role').eq('id', user.id).single();
      if (error) return log('profile-log', error.message);
      $('username').value = data?.username || '';
      $('role').textContent = 'Ruolo: ' + (data?.role || 'user');
      const showAdminBtn = user.id === SUPER_UID && (data?.role !== 'admin');
      $('btn-become-admin').classList.toggle('hidden', !showAdminBtn);
    }
    async function saveProfile(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return log('profile-log','Login richiesto');
      const username = $('username').value.trim();
      if (username && (username.length < 3 || username.length > 32)) return log('profile-log','Username 3–32 caratteri');
      const { error } = await supabase.from('profiles').update({ username }).eq('id', user.id);
      log('profile-log', error ? error.message : 'Profilo aggiornato');
    }
    async function becomeAdmin(){
      const { error } = await supabase.rpc('become_admin');
      log('profile-log', error ? error.message : 'Ora sei admin');
      await loadProfile();
    }

    function renderTableItem(t, counts, creators){
      const reserved = counts.get(t.id) || 0;
      const creator = creators.get(t.creator_id) || '—';
      const tagSpans = (t.tags || []).map(x=>`<span class="tag">${x}</span>`).join(' ');
      return `
        <div class="item" data-id="${t.id}">
          <div class="row">
            <div style="flex:0 0 180px">
              ${t.image_url ? `<img src="${t.image_url}" alt="" class="thumb" />` : `<div class="noimg">Nessuna immagine</div>`}
            </div>
            <div style="flex:1">
              <h3 style="margin:0 0 6px 0">${t.title}</h3>
              <div class="meta">
                <span>${fmtDate(t.starts_at)}</span>
                <span>Posti: ${reserved}/${t.max_seats}</span>
                <span>Complessità: ${t.complexity_label}</span>
                <span>Creato da: ${creator}</span>
              </div>
              <p class="muted" style="margin:8px 0 6px 0">${t.description}</p>
              <div class="tags">${tagSpans}</div>
              <div class="row" style="margin-top:10px">
                <button data-act="reserve" type="button" class="btn-accent">Prenota</button>
                <button data-act="unreserve" type="button" class="btn-danger">Annulla</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function fetchTavoli(signal){
      const { data, error } = await supabase
        .from('tavoli')
        .select('id,title,description,starts_at,max_seats,complexity_label,image_url,created_at,creator_id,tags')
        .order('created_at',{ascending:false})
        .limit(200)
        .abortSignal?.(signal);
      if (error) throw error;
      return data || [];
    }
    async function fetchReservationCounts(signal){
      const { data, error } = await supabase.from('reservations').select('tavolo_id').abortSignal?.(signal);
      if (error) throw error;
      const m = new Map();
      for (const r of (data || [])) m.set(r.tavolo_id, (m.get(r.tavolo_id) || 0) + 1);
      return m;
    }
    async function fetchCreatorsUsernames(ids){
      if (!ids.length) return new Map();
      const { data, error } = await supabase.from('profiles').select('id,username').in('id', ids);
      if (error) return new Map();
      const m = new Map();
      for (const r of data || []) m.set(r.id, r.username || null);
      return m;
    }
    async function listTavoliWithExtras(signal){
      const [list, counts] = await Promise.all([fetchTavoli(signal), fetchReservationCounts(signal)]);
      const ids = [...new Set(list.map(x=>x.creator_id))].filter(Boolean);
      const creators = await fetchCreatorsUsernames(ids);
      return { list, counts, creators };
    }

    async function loadTavoli(){
      const ctl = new AbortController();
      try{
        log('tables-log','Caricamento…');
        const { list, counts, creators } = await listTavoliWithExtras(ctl.signal);
        const html = list.map(t=>renderTableItem(t, counts, creators)).join('');
        $('tables').innerHTML = html;
        bindTableButtons('tables');
        log('tables-log','');
      }catch(e){ log('tables-log', e.message || String(e)); }
      return ()=>ctl.abort();
    }

    async function loadMine(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const ctl = new AbortController();
      try{
        const { data, error } = await supabase.from('tavoli').select('*').eq('creator_id', user.id).order('created_at',{ascending:false}).limit(100).abortSignal?.(ctl.signal);
        if (error) throw error;
        const counts = await fetchReservationCounts(ctl.signal);
        const creators = await fetchCreatorsUsernames([user.id]);
        const html = (data || []).map(t=>renderTableItem(t, counts, creators)).join('');
        $('mine').innerHTML = html;
        bindTableButtons('mine');
      }catch(e){
        $('mine').innerHTML='';
      }
      return ()=>ctl.abort();
    }

    function bindTableButtons(containerId){
      document.querySelectorAll(`#${containerId} .item`).forEach(el=>{
        const t = { id: el.dataset.id };
        el.querySelector('[data-act="reserve"]').addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const { error } = await supabase.from('reservations').insert({ tavolo_id: t.id });
          if (error) alert(error.message);
          else await Promise.all([loadTavoli(), loadMine()]);
        });
        el.querySelector('[data-act="unreserve"]').addEventListener('click', async (ev)=>{
          ev.preventDefault();
          const { data, error } = await supabase.from('reservations').select('id').eq('tavolo_id', t.id).limit(1).single();
          if (error) return alert(error.message);
          const { error: err2 } = await supabase.from('reservations').delete().eq('id', data.id);
          if (err2) alert(err2.message);
          else await Promise.all([loadTavoli(), loadMine()]);
        });
      });
    }

    function parseFutureLocalDateTime(input){
      if (!input) return { ok:false, error:'Data/ora obbligatoria' };
      const d = new Date(input);
      if (Number.isNaN(+d)) return { ok:false, error:'Data/ora non valida' };
      if (d <= new Date()) return { ok:false, error:'Seleziona una data nel futuro' };
      return { ok:true, value:d.toISOString() };
    }
    async function createTavolo(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return log('create-log','Login richiesto');

      const title = $('title').value.trim();
      const description = $('description').value.trim();
      const starts_input = $('starts_at').value;
      const seats = Number($('max_seats').value);
      const complexity_label = $('complexity_label').value;
      const image_url = $('image_url').value.trim();
      const tags = SELECTED_TAGS.slice();

      if (!title) return log('create-log','Titolo obbligatorio');
      if (!description) return log('create-log','Descrizione obbligatoria');
      const dt = parseFutureLocalDateTime(starts_input);
      if (!dt.ok) return log('create-log', dt.error);
      if (!Number.isFinite(seats) || seats < 1) return log('create-log','Posti deve essere >= 1');
      const allowed = new Set(['molto semplice','semplice','medio','complesso','molto complesso']);
      if (!allowed.has(complexity_label)) return log('create-log','Complessità non valida');

      const payload = {
        title, description, starts_at: dt.value, max_seats: seats,
        complexity_label, image_url: image_url || null, tags, creator_id: user.id
      };

      const { error } = await supabase.from('tavoli').insert(payload);
      log('create-log', error ? error.message : 'Tavolo creato');
      if (!error){
        $('title').value=''; $('description').value='';
        $('starts_at').value=''; $('max_seats').value='';
        $('image_url').value=''; $('complexity_label').value='medio';
        SELECTED_TAGS = []; renderTagsSummary();
        await loadTavoli(); await loadMine();
      }
    }

    // ---------- Bind + initial ----------
    function bind(){
      const map = [
        ['btn-signup',        signUp],
        ['btn-signin',        signIn],
        ['btn-anon',          signInAnon],
        ['btn-signout',       signOut],
        ['btn-save-profile',  saveProfile],
        ['btn-create',        createTavolo],
        ['btn-refresh',       async ()=>{ await Promise.all([loadTavoli(), loadMine()]); }],
        ['btn-tags',          openTagsDialog],
        ['tags-apply',        applyTagsDialog],
        ['tags-cancel',       closeTagsDialog],
        ['btn-become-admin',  becomeAdmin],
      ];
      for (const [id,fn] of map){
        const el=$(id); if (el) el.addEventListener('click', (ev)=>{ ev.preventDefault(); fn?.(); });
      }
      document.addEventListener('keydown', (e)=>{
        if (e.key==='Escape'){ const dlg=$('tags-dialog'); dlg?.open && dlg.close(); }
      });
      buildTagsList();
    }

    async function signUp(){
      const email=$('email').value.trim(), password=$('password').value.trim();
      const { error } = await supabase.auth.signUp({ email, password });
      log('auth-log', error ? error.message : 'Controlla l’email per confermare');
    }
    async function signIn(){
      const email=$('email').value.trim(), password=$('password').value.trim();
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      log('auth-log', error ? error.message : 'Accesso effettuato');
    }
    async function signInAnon(){
      const { error } = await supabase.auth.signInAnonymously();
      log('auth-log', error ? error.message : 'Accesso anonimo attivo');
    }
    async function signOut(){
      const { error } = await supabase.auth.signOut();
      if (error) return log('auth-log', error.message);
      resetUI();
      renderAuth(false);
    }

    function renderAuth(ok){
      setBadge('auth-ok', ok);
      $('app').classList.toggle('hidden', !ok);
      $('app').setAttribute('aria-hidden', String(!ok));
    }
    function resetUI(){
      $('whoami').textContent='Utente: —';
      $('role').textContent='Ruolo: —';
      $('tables').innerHTML=''; $('mine').innerHTML='';
      log('tables-log',''); log('auth-log',''); log('profile-log',''); log('create-log','');
      SELECTED_TAGS = []; renderTagsSummary();
      $('btn-become-admin').classList.add('hidden');
    }

    let bootPromise = null;
    function bootDataOnce(){
      if (bootPromise) return bootPromise;
      bootPromise = (async ()=>{
        renderTagsSummary();
        await loadProfile();
        await Promise.all([loadTavoli(), loadMine()]);
      })().finally(()=>{ bootPromise = null; });
      return bootPromise;
    }

    window.__sbAuthSub?.unsubscribe?.();
    window.__sbAuthSub = supabase.auth.onAuthStateChange(async (event, session) => {
      renderAuth(!!session);
      if (session){
        $('whoami').textContent = 'Utente: ' + (session.user.email || session.user.id);
        await bootDataOnce();
      }else{
        resetUI();
      }
    });

    function buildTagsList(){
      const box=$('tags-list'); box.innerHTML='';
      for (const t of ALL_TAGS){
        const id='tag-'+t;
        const label=document.createElement('label');
        label.innerHTML=`<input type="checkbox" id="${id}" value="${t}"><span>${t}</span>`;
        box.appendChild(label);
      }
    }
    function openTagsDialog(){
      const dlg=$('tags-dialog'); dlg.showModal();
      // sync checks
      for (const t of ALL_TAGS){
        const el=document.getElementById('tag-'+t);
        if (el) el.checked = SELECTED_TAGS.includes(t);
      }
      // click outside to close
      dlg.addEventListener('click', function onClick(e){
        const rect = dlg.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if (!inside) dlg.close();
      });
    }
    function applyTagsDialog(){
      const next=[];
      for (const t of ALL_TAGS){
        const el=document.getElementById('tag-'+t);
        if (el?.checked) next.push(t);
      }
      SELECTED_TAGS = next;
      renderTagsSummary();
      closeTagsDialog();
    }
    function closeTagsDialog(){
      const dlg=$('tags-dialog'); dlg.close();
    }

    (async ()=>{
      bind();
      const { data: { session } } = await supabase.auth.getSession();
      renderAuth(!!session);
      if (session){ $('whoami').textContent = 'Utente: ' + (session.user.email || session.user.id); bootDataOnce(); }
    })();
  </script>
</body>
</html>
