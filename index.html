<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempio Ludico — Tavoli</title>
  <meta name="theme-color" content="#ed445b" />
  <link rel="icon" href="LogoTempioLudicoNoBackground.PNG" />
  <style>
    :root{--bg:#ed445b;--ink:#0b0f14;--card:#fff;--muted:#5b6c85;--b:#e5e7eb;--b2:#d1d5db}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;color:#fff;gap:10px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .badge{font-size:12px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:2px 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn{background:#111;color:#fff}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-light{background:#fff;color:#111;border:1px solid var(--b)}
    .btn-danger{background:#b91c1c;color:#fff}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--b)}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 12}@media(min-width:880px){.col-6{grid-column:span 6}}
    .caps{letter-spacing:.04em;text-transform:uppercase;font-weight:700;font-size:12px}
    .pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;background:#f4f4f5;border:1px solid #e4e4e7;font-size:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--b2);padding:8px;text-align:left;font-size:14px;vertical-align:top}
    dialog{border:0;border-radius:12px;max-width:620px;width:min(92vw,620px);padding:0}
    dialog>form{padding:16px}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--b2);font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{border:1px solid var(--b2);padding:4px 8px;border-radius:999px;background:#fafafa;font-size:12px}
    .kpi{display:flex;gap:10px;align-items:center}
    .kpi .n{font-weight:800}
    .table-card{display:grid;grid-template-columns: 1fr;gap:10px}
    .table-act{display:flex;gap:8px;flex-wrap:wrap}
  </style>
  <!-- Provides SUPABASE_URL and SUPABASE_ANON_KEY -->
  <script src="./env.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <img src="./LogoTempioLudicoNoBackground.PNG" alt="logo" width="44" height="44" style="border-radius:999px;background:#fff"/>
        <h1>Tempio Ludico — Tavoli</h1>
      </div>
      <div class="row">
        <span id="role" class="badge">Ruolo: —</span>
        <span id="whoami" class="badge">Utente: —</span>
        <button id="btn-login" class="btn-light">Accedi</button>
        <button id="btn-logout" class="btn">Esci</button>
      </div>
    </header>

    <!-- Auth card -->
    <section id="auth" class="card">
      <h2 class="caps">Accesso</h2>
      <div class="grid">
        <div class="col-6">
          <div class="muted">Accedi con email e password</div>
          <input id="login-email" type="email" placeholder="Email" />
          <input id="login-password" type="password" placeholder="Password" style="margin-top:8px" />
          <div class="row" style="margin-top:8px">
            <button id="btn-email-login" class="btn">Accedi</button>
          </div>
          <div id="login-msg" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="col-6">
          <div class="muted">Non hai un account?</div>
          <div class="row" style="margin-top:8px">
            <button id="btn-open-signup" class="btn-light">Registrati</button>
          </div>
        </div>
      </div>
    </section>

    <!-- App card -->
    <section id="app" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="kpi"><span class="muted">Tavoli aperti:</span> <span id="kpi-count" class="n">0</span></div>
        <div class="row">
          <button id="btn-open-create" class="btn hidden">Crea tavolo</button>
          <button id="btn-open-mine" class="btn-light hidden">Le mie prenotazioni</button>
        </div>
      </div>
      <div id="tables-log" class="muted" style="margin-top:6px"></div>
      <div id="tables" style="margin-top:10px"></div>
    </section>
  </div>

  <!-- Signup dialog -->
  <dialog id="signup-dialog">
    <form method="dialog">
      <h3>Registrazione</h3>
      <input id="signup-email" type="email" placeholder="Email" />
      <input id="signup-password" type="password" placeholder="Password" style="margin-top:8px" />
      <div class="row" style="margin-top:10px">
        <button id="btn-email-signup" class="btn">Crea account</button>
        <button value="cancel" class="btn-light">Annulla</button>
      </div>
      <div id="signup-msg" class="muted" style="margin-top:6px"></div>
    </form>
  </dialog>

  <!-- Create/Edit table dialog -->
  <dialog id="table-dialog">
    <form method="dialog">
      <h3 id="table-dialog-title">Nuovo tavolo</h3>
      <div class="grid">
        <div class="col-6">
          <label class="caps">Titolo</label>
          <input id="t-title" type="text" placeholder="Nome del tavolo" />
        </div>
        <div class="col-6">
          <label class="caps">Data e ora</label>
          <input id="t-starts" type="datetime-local" />
        </div>
        <div class="col-6">
          <label class="caps">Giocatori max</label>
          <input id="t-max" type="number" min="1" step="1" />
        </div>
        <div class="col-6">
          <label class="caps">Complessità</label>
          <input id="t-complexity" type="text" placeholder="es. Family, Medium, Expert" />
        </div>
        <div class="col-12">
          <label class="caps">Descrizione</label>
          <textarea id="t-desc" placeholder="Dettagli"></textarea>
        </div>
        <div class="col-12">
          <label class="caps">Tag (separati da virgola)</label>
          <input id="t-tags" type="text" placeholder="German, Cooperativo,..." />
        </div>
        <div class="col-12">
          <label class="caps">Immagine (URL opzionale)</label>
          <input id="t-image" type="url" placeholder="https://..." />
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btn-save-table" class="btn">Salva</button>
        <button value="cancel" class="btn-light">Annulla</button>
      </div>
      <div id="table-msg" class="muted" style="margin-top:6px"></div>
    </form>
  </dialog>

  <!-- My reservations dialog -->
  <dialog id="mine-dialog">
    <form method="dialog">
      <h3>Le mie prenotazioni</h3>
      <div id="mine-list" class="muted">Caricamento…</div>
      <div class="row" style="margin-top:12px">
        <button value="cancel" class="btn">Chiudi</button>
      </div>
    </form>
  </dialog>

  <!-- App script: import ESM and create client locally -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
      throw new Error('SUPABASE_URL or SUPABASE_ANON_KEY missing. Check env.js');
    }

    // Supabase client
    const supabase = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    // State
    let SESSION = null;
    let IS_ADMIN = false;
    let EDITING_TABLE_ID = null;

    // Shortcuts
    const $ = (id)=>document.getElementById(id);
    const fmtErr = (e)=> e?.message || e?.error_description || String(e);

    // UI toggles
    function renderAuth(authed){
      $('btn-login').classList.toggle('hidden', authed);
      $('btn-logout').classList.toggle('hidden', !authed);
      $('btn-open-create').classList.toggle('hidden', !authed || !IS_ADMIN);
      $('btn-open-mine').classList.toggle('hidden', !authed);
      $('app').classList.toggle('hidden', !authed);
      $('auth').classList.toggle('hidden', authed);
    }

    function setWho(role, user){
      $('role').textContent = 'Ruolo: ' + (IS_ADMIN ? 'admin' : role || 'user');
      $('whoami').textContent = 'Utente: ' + (user?.email || user?.id || '—');
    }

    // Ensure a profile row exists and load profiles.is_admin
    async function ensureProfileAndRole(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ IS_ADMIN=false; setWho('—', null); return; }

      const username = user.email?.split('@')[0] || null;

      // Upsert only id and username. Do not touch is_admin here.
      const up = await supabase
        .from('profiles')
        .upsert({ id: user.id, username }, { onConflict: 'id', ignoreDuplicates: false })
        .select('id,is_admin')
        .maybeSingle();

      if (up.error && up.error.code !== '23505') console.warn('[profiles upsert]', up.error);

      const { data, error } = await supabase
        .from('profiles')
        .select('is_admin')
        .eq('id', user.id)
        .maybeSingle();

      IS_ADMIN = !error && !!data?.is_admin;
      setWho(IS_ADMIN ? 'admin' : 'user', user);
      $('btn-open-create').classList.toggle('hidden', !IS_ADMIN);
    }

    // ---------- Tables and reservations ----------

    async function fetchTablesWithReservations(){
      const { data: tables, error } = await supabase
        .from('tavoli')
        .select('id,title,description,starts_at,max_seats,tags,image_url,creator_id,created_at,complexity_label')
        .order('starts_at', { ascending: true });
      if (error) throw error;

      if (!tables?.length) return [];

      const ids = tables.map(t=>t.id);
      const { data: resv, error: rerr } = await supabase
        .from('reservations')
        .select('id,tavolo_id,user_id,username_snapshot,created_at')
        .in('tavolo_id', ids);
      if (rerr) throw rerr;

      const byTable = new Map();
      for (const t of tables){ byTable.set(t.id, { table: t, reservations: [] }); }
      for (const r of resv){ byTable.get(r.tavolo_id)?.reservations.push(r); }

      return Array.from(byTable.values()).map(({table,reservations})=>{
        const taken = reservations.length;
        const max = table.max_seats ?? 0;
        return { table, reservations, taken, available: Math.max(0, max - taken) };
      });
    }

    function reservationRow(r, me){
      const meFlag = r.user_id === me?.id ? ' <span class="pill">tu</span>' : '';
      return `<div>${r.username_snapshot || r.user_id}${meFlag}</div>`;
    }

    function tableCard(model, me){
      const { table: t, reservations, taken, available } = model;
      const when = t.starts_at ? new Date(t.starts_at).toLocaleString() : '';
      const tagsHtml = (t.tags||[]).map(x=>`<span class="chip">${x}</span>`).join('');
      const iAmBooked = reservations.some(r=>r.user_id === me?.id);

      const host = document.createElement('div');
      host.className = 'card';
      host.innerHTML = `
        <div class="table-card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">${t.title || 'Senza titolo'}</div>
              <div class="muted">${when}${t.complexity_label ? ' · ' + t.complexity_label : ''}</div>
            </div>
            <div class="kpi">
              <span class="pill">Posti ${taken}/${t.max_seats ?? 0}</span>
              ${available <= 0 ? '<span class="pill">Completo</span>' : ''}
            </div>
          </div>

          ${t.description ? `<div>${t.description}</div>` : ''}

          ${(t.tags && t.tags.length) ? `<div class="chips">${tagsHtml}</div>` : ''}

          <div>
            <div class="caps" style="margin-bottom:6px">Prenotati</div>
            <div>${reservations.map(r=>reservationRow(r, me)).join('') || '<span class="muted">Nessuno</span>'}</div>
          </div>

          <div class="table-act">
            <button class="btn ${iAmBooked ? '' : 'hidden'}" data-action="unreserve" data-id="${t.id}">Annulla prenotazione</button>
            <button class="btn ${(!iAmBooked && available>0) ? '' : 'hidden'}" data-action="reserve" data-id="${t.id}">Prenota posto</button>
            ${IS_ADMIN ? `<button class="btn-light" data-action="edit" data-id="${t.id}">Modifica</button>` : ''}
            ${(IS_ADMIN || t.creator_id === SESSION?.user?.id) ? `<button class="btn-danger" data-action="delete" data-id="${t.id}">Elimina tavolo</button>` : ''}
          </div>
        </div>
      `;
      return host;
    }

    async function renderTables(){
      $('tables-log').textContent = 'Caricamento…';
      const host = $('tables'); host.innerHTML='';
      try{
        const list = await fetchTablesWithReservations();
        $('kpi-count').textContent = list.length;
        if (!list.length){ host.innerHTML = '<div class="muted">Nessun tavolo</div>'; }
        else {
          const { data: { user } } = await supabase.auth.getUser();
          const frag = document.createDocumentFragment();
          for (const m of list) frag.appendChild(tableCard(m, user));
          host.appendChild(frag);
          host.querySelectorAll('[data-action]').forEach(btn=>{
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            btn.onclick = ()=> handleTableAction(action, id);
          });
        }
        $('tables-log').textContent = '';
      }catch(err){
        $('tables-log').textContent = 'Errore: ' + fmtErr(err);
      }
    }

    async function handleTableAction(action, id){
      try{
        if (action === 'reserve'){
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) throw new Error('Login richiesto');
          const existing = await supabase.from('reservations')
            .select('id').eq('tavolo_id', id).eq('user_id', user.id).maybeSingle();
          if (!existing.error && existing.data){
            // already reserved
          } else {
            const prof = await supabase.from('profiles').select('username').eq('id', user.id).maybeSingle();
            const username_snapshot = prof.data?.username || user.email || user.id;
            const ins = await supabase.from('reservations')
              .insert({ tavolo_id: id, user_id: user.id, username_snapshot })
              .select('id')
              .maybeSingle();
            if (ins.error) throw ins.error;
          }
          await renderTables();
          return;
        }
        if (action === 'unreserve'){
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) throw new Error('Login richiesto');
          const del = await supabase.from('reservations')
            .delete().eq('tavolo_id', id).eq('user_id', user.id);
          if (del.error) throw del.error;
          await renderTables();
          return;
        }
        if (action === 'delete'){
          if (!IS_ADMIN){ throw new Error('Solo admin'); }
          const del = await supabase.from('reservations').delete().eq('tavolo_id', id);
          if (del.error) throw del.error;
          const delT = await supabase.from('tavoli').delete().eq('id', id);
          if (delT.error) throw delT.error;
          await renderTables();
          return;
        }
        if (action === 'edit'){
          if (!IS_ADMIN){ throw new Error('Solo admin'); }
          const q = await supabase.from('tavoli').select('*').eq('id', id).maybeSingle();
          if (q.error) throw q.error;
          EDITING_TABLE_ID = q.data.id;
          $('table-dialog-title').textContent = 'Modifica tavolo';
          $('t-title').value = q.data.title || '';
          $('t-starts').value = q.data.starts_at ? toLocalInput(q.data.starts_at) : '';
          $('t-max').value = q.data.max_seats ?? '';
          $('t-complexity').value = q.data.complexity_label || '';
          $('t-desc').value = q.data.description || '';
          $('t-tags').value = (q.data.tags||[]).join(', ');
          $('t-image').value = q.data.image_url || '';
          $('table-msg').textContent = '';
          $('table-dialog').showModal();
          return;
        }
      }catch(err){
        alert('Errore: ' + fmtErr(err));
      }
    }

    // ---------- Create/Edit table ----------
    function toLocalInput(ts){
      const d = new Date(ts);
      const pad = (n)=>String(n).padStart(2,'0');
      const v = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      return v;
    }

    $('btn-save-table').onclick = async (e)=>{
      e.preventDefault();
      $('table-msg').textContent = '';
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Login richiesto');
        if (!IS_ADMIN) throw new Error('Solo admin');

        const title = $('t-title').value.trim();
        const starts = $('t-starts').value ? new Date($('t-starts').value).toISOString() : null;
        const max = Number.parseInt($('t-max').value || '0', 10) || null;
        const complexity = $('t-complexity').value.trim() || null;
        const description = $('t-desc').value.trim() || null;
        const tags = $('t-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
        const image_url = $('t-image').value.trim() || null;

        if (!title) throw new Error('Titolo obbligatorio');

        const payload = {
          title, starts_at: starts, max_seats: max, complexity_label: complexity,
          description, tags: tags.length ? tags : null, image_url,
          creator_id: user.id
        };

        if (EDITING_TABLE_ID){
          const upd = await supabase.from('tavoli').update(payload).eq('id', EDITING_TABLE_ID);
          if (upd.error) throw upd.error;
        } else {
          const ins = await supabase.from('tavoli').insert(payload);
          if (ins.error) throw ins.error;
        }

        $('table-dialog').close();
        EDITING_TABLE_ID = null;
        $('t-title').value = '';
        $('t-starts').value = '';
        $('t-max').value = '';
        $('t-complexity').value = '';
        $('t-desc').value = '';
        $('t-tags').value = '';
        $('t-image').value = '';
        await renderTables();
      }catch(err){
        $('table-msg').textContent = fmtErr(err);
      }
    };

    // ---------- My reservations ----------
    $('btn-open-mine').onclick = async ()=>{
      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ alert('Login richiesto'); return; }
      $('mine-list').textContent = 'Caricamento…';
      $('mine-dialog').showModal();

      const q = await supabase
        .from('reservations')
        .select('id,created_at,tavolo_id,username_snapshot,tavoli:title=tavolo_id ( id, title, starts_at )')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (q.error){ $('mine-list').textContent = fmtErr(q.error); return; }

      if (!q.data?.length){ $('mine-list').innerHTML = '<span class="muted">Nessuna prenotazione</span>'; return; }

      const rows = q.data.map(r=>{
        const when = r.tavoli?.starts_at ? new Date(r.tavoli.starts_at).toLocaleString() : '';
        return `<div class="card" style="margin-bottom:8px">
                  <div style="font-weight:700">${r.tavoli?.title || r.tavolo_id}</div>
                  <div class="muted">${when}</div>
                  <div class="row" style="margin-top:8px">
                    <button class="btn" data-cancel="${r.tavolo_id}">Annulla prenotazione</button>
                  </div>
                </div>`;
      }).join('');
      $('mine-list').innerHTML = rows;

      $('mine-list').querySelectorAll('[data-cancel]').forEach(b=>{
        b.onclick = async ()=>{
          const id = b.getAttribute('data-cancel');
          const del = await supabase.from('reservations').delete().eq('tavolo_id', id).eq('user_id', (await supabase.auth.getUser()).data.user.id);
          if (del.error){ alert(fmtErr(del.error)); return; }
          await renderTables();
          $('mine-dialog').close();
        };
      });
    };

    // ---------- Auth ----------
    async function doPasswordLogin(){
      const email = $('login-email').value.trim();
      const password = $('login-password').value;
      $('login-msg').textContent = '';
      if (!email || !password){ $('login-msg').textContent = 'Email e password sono obbligatorie'; return; }
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error){ $('login-msg').textContent = fmtErr(error); return; }
      SESSION = { user: data.user };
      await ensureProfileAndRole();
      renderAuth(true);
      await renderTables();
    }

    async function doPasswordSignup(){
      const email = $('signup-email').value.trim();
      const password = $('signup-password').value;
      $('signup-msg').textContent = '';
      if (!email || !password){ $('signup-msg').textContent = 'Email e password sono obbligatorie'; return; }
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error){ $('signup-msg').textContent = fmtErr(error); return; }
      if (!data.user){ $('signup-msg').textContent = 'Registrazione eseguita. Controlla l’email per la conferma.'; return; }
      $('signup-dialog').close();
      SESSION = { user: data.user };
      await ensureProfileAndRole();
      renderAuth(true);
      await renderTables();
    }

    function resetUI(){
      SESSION = null;
      IS_ADMIN = false;
      $('whoami').textContent = 'Utente: —';
      $('role').textContent = 'Ruolo: —';
      renderAuth(false);
      $('tables').innerHTML = '';
      $('tables-log').textContent = '';
    }

    // Wire buttons
    $('btn-login').onclick = ()=> $('login-email').focus();
    $('btn-logout').onclick = async ()=>{
      await supabase.auth.signOut();
      resetUI();
    };
    $('btn-open-signup').onclick = ()=> $('signup-dialog').showModal();
    $('btn-email-signup').onclick = (e)=>{ e.preventDefault(); doPasswordSignup(); };
    $('btn-email-login').onclick = (e)=>{ e.preventDefault(); doPasswordLogin(); };
    $('btn-open-create').onclick = ()=>{
      EDITING_TABLE_ID = null;
      $('table-dialog-title').textContent = 'Nuovo tavolo';
      $('t-title').value = '';
      $('t-starts').value = '';
      $('t-max').value = '';
      $('t-complexity').value = '';
      $('t-desc').value = '';
      $('t-tags').value = '';
      $('t-image').value = '';
      $('table-msg').textContent = '';
      $('table-dialog').showModal();
    };

    // Boot + auth state subscription
    (async function boot(){
      const { data: { session } } = await supabase.auth.getSession();
      SESSION = session || null;
      const authed = !!session?.user;
      if (authed){
        await ensureProfileAndRole();
        renderAuth(true);
        await renderTables();
      } else {
        resetUI();
      }
      const { data: subscription } = supabase.auth.onAuthStateChange(async (_e, s)=>{
        const authed = !!s?.user;
        SESSION = s || null;
        if (authed){
          await ensureProfileAndRole();
          renderAuth(true);
          await renderTables();
        } else {
          resetUI();
        }
      });
      window.__sbAuthSub = subscription;
    })();
  </script>
</body>
</html>
