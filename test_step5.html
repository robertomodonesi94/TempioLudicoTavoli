<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Test — v_tavolo_reservations</title>

  <!-- Must exist and load BEFORE any code below. It sets window.SUPABASE_URL and window.SUPABASE_ANON_KEY -->
  <script src="/env.js"></script>

  <!-- Optional SDK (not required for the REST test, but handy if you later switch to supabase-js) -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>

  <style>
    :root{--ink:#111827;--muted:#6b7280;--b:#e5e7eb;--card:#fff;--brand:#ed445b;--bg:#fafafa;--err:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);padding:12px 16px}
    h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px}
    .muted{color:var(--muted);font-size:12px}
    .seat{display:grid;grid-template-columns:140px 1fr auto;gap:10px;align-items:center;border:1px solid var(--b);border-radius:10px;padding:8px 10px;background:#fff;margin-top:8px}
    .pill{border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:12px}
    pre{white-space:pre-wrap;background:#fff;border:1px solid var(--b);padding:10px;border-radius:10px}
    .error{color:var(--err);white-space:pre-wrap}
    .ok{color:#16a34a}
  </style>
</head>
<body>
  <header><h1>Debug — <span style="color:var(--brand);font-weight:800">v_tavolo_reservations</span></h1></header>
  <main>
    <div id="env" class="muted">Checking env…</div>

    <h2>Output</h2>
    <div id="content">Caricamento…</div>

    <h2>Network/Response Debug</h2>
    <details open>
      <summary>Last REST call</summary>
      <pre id="dbg">Waiting…</pre>
    </details>
  </main>

  <!-- FORCE a REST GET so you will see /rest/v1/v_tavolo_reservations in DevTools → Network -->
  <script>
  (async () => {
    const URL = (window && window.SUPABASE_URL) || '';
    const KEY = (window && window.SUPABASE_ANON_KEY) || '';
    const envEl = document.getElementById('env');
    const out = document.getElementById('content');
    const dbg = document.getElementById('dbg');

    // 1) Show env status
    envEl.textContent = `URL: ${URL || '(missing)'}  |  KEY present: ${KEY ? 'yes' : 'no'}`;

    if (!URL || !KEY) {
      out.innerHTML = '<div class="error">Missing SUPABASE_URL or SUPABASE_ANON_KEY from /env.js</div>';
      return;
    }

    // 2) Build the REST request to the exact view name
    const params = new URLSearchParams({
      select: 'tavolo_id,user_id,display_name,status,created_at,tavolo_title,tavolo_starts_at',
      order: 'created_at.asc'
    });
    const path = `/rest/v1/v_tavolo_reservations?${params}`;

    // 3) Fire the request. This MUST appear in Network.
    try {
      const res = await fetch(URL + path, {
        headers: { apikey: KEY, Authorization: `Bearer ${KEY}` }
      });

      let json = null;
      try { json = await res.clone().json(); } catch (_) { json = null; }

      // Print raw debug
      dbg.textContent = JSON.stringify(
        { path, status: res.status, rows: Array.isArray(json) ? json.length : null, sample: Array.isArray(json) ? json.slice(0, 3) : json },
        null, 2
      );

      if (!res.ok) {
        out.innerHTML = `<div class="error">Errore REST ${res.status}. Vedi "Last REST call" sopra per dettagli.</div>`;
        return;
      }

      const rows = Array.isArray(json) ? json : [];
      if (rows.length === 0) {
        out.innerHTML = '<div class="card"><div class="muted">Nessuna prenotazione.</div></div>';
        return;
      }

      // 4) Render grouped by tavolo_id
      const byTable = new Map();
      for (const r of rows) {
        const key = r.tavolo_id;
        if (!byTable.has(key)) byTable.set(key, { title: r.tavolo_title || `Tavolo ${key}`, when: r.tavolo_starts_at, rows: [] });
        byTable.get(key).rows.push(r);
      }

      out.innerHTML = '<div class="grid"></div>';
      const grid = out.querySelector('.grid');

      const fmtDate = s => { try { return s ? new Date(s).toLocaleString() : ''; } catch { return s || ''; } };

      for (const [tid, g] of byTable) {
        const card = document.createElement('div');
        card.className = 'card';
        const when = g.when ? `<div class="muted">Inizio: ${fmtDate(g.when)}</div>` : '';
        card.innerHTML = `<h3 style="margin:0 0 8px 0">${g.title}</h3>${when}<div class="muted">Visibile a tutti gli utenti</div>`;

        for (const r of g.rows) {
          const line = document.createElement('div');
          line.className = 'seat';
          line.innerHTML = `
            <div>${fmtDate(r.created_at)}</div>
            <div>${r.display_name || '—'}</div>
            ${r.status ? `<div class="pill">${r.status}</div>` : ''}`;
          card.appendChild(line);
        }
        grid.appendChild(card);
      }
    } catch (e) {
      dbg.textContent = 'Exception: ' + (e && e.message ? e.message : String(e));
      out.innerHTML = `<div class="error">Eccezione: ${e && e.message ? e.message : String(e)}</div>`;
    }
  })();
  </script>
</body>
</html>
