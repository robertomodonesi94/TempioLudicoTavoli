<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tempio Ludico — Prenotazioni Tavoli</title>

  <!-- Supabase SDK and your env -->
  <script type="module" src="https://esm.sh/@supabase/supabase-js@2"></script>
  <script src="/env.js"></script>

  <style>
    :root{
      --ink:#111827;--muted:#6b7280;--b:#e5e7eb;--card:#fff;--brand:#ed445b;
      --bg:#fafafa;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);padding:12px 16px;z-index:10}
    h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:18px auto;padding:0 16px 40px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
    input[type="search"]{padding:8px 10px;border:1px solid var(--b);border-radius:10px;min-width:260px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:8px}
    .card h2{margin:0 0 2px 0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}
    .seat{display:grid;grid-template-columns:140px 1fr auto;gap:10px;align-items:center;border:1px solid var(--b);border-radius:10px;padding:8px 10px;background:#fff}
    .pill{border:1px solid var(--b);border-radius:999px;padding:2px 8px;font-size:12px}
    .status-pending{border-color:var(--warn)}
    .status-confirmed{border-color:var(--ok)}
    .status-cancelled{border-color:var(--err)}
    .empty{padding:20px;border:1px dashed var(--b);border-radius:12px;text-align:center;color:var(--muted)}
    .brand{color:var(--brand);font-weight:800}
    .error{color:var(--err);font-weight:600}
  </style>
</head>
<body>
  <header><h1>Prenotazioni Tavoli <span class="brand">Tempio Ludico</span></h1></header>
  <main>
    <div class="controls">
      <!-- Optional filter by tavolo via query param or dropdown populated from data -->
      <input id="search" type="search" placeholder="Filtra per titolo tavolo o nome utente…" />
      <div id="meta" class="muted"></div>
    </div>
    <div id="content">Caricamento…</div>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // 1) Initialize client. env.js MUST define these. If not, you can hardcode (not recommended).
    const URL = window.SUPABASE_URL;
    const KEY = window.SUPABASE_ANON_KEY;
    const supabase = createClient(URL, KEY, { auth: { persistSession: true } });

    // 2) Page wiring
    const el = {
      content: document.getElementById('content'),
      search: document.getElementById('search'),
      meta: document.getElementById('meta')
    };

    // Optional: restrict to a single tavolo with ?tavolo_id=<uuid>
    const params = new URLSearchParams(location.search);
    const ONLY = params.get('tavolo_id') || '';

    // 3) Data load
    async function loadReservations() {
      // Build query against the VIEW we created in the DB
      let q = supabase
        .from('v_tavolo_reservations')
        .select('tavolo_id, tavolo_title, tavolo_starts_at, user_id, display_name, status, note, created_at');

      if (ONLY) q = q.eq('tavolo_id', ONLY);

      const { data, error } = await q
        .order('tavolo_id', { ascending: true })
        .order('created_at', { ascending: true });

      if (error) {
        el.content.innerHTML = `<div class="error">Errore caricamento: ${error.message || error}</div>`;
        console.error('v_tavolo_reservations error', error);
        return [];
      }
      return data ?? [];
    }

    // 4) Rendering
    function fmtDate(s) {
      if (!s) return '';
      try { return new Date(s).toLocaleString(); } catch { return s; }
    }

    function render(rows) {
      // Filter by search text
      const term = (el.search.value || '').toLowerCase().trim();
      const filtered = term
        ? rows.filter(r =>
            (r.tavolo_title || '').toLowerCase().includes(term) ||
            (r.display_name || '').toLowerCase().includes(term))
        : rows;

      // Group by tavolo_id
      const byTable = new Map();
      for (const r of filtered) {
        const key = r.tavolo_id;
        if (!byTable.has(key)) byTable.set(key, { title: r.tavolo_title || `Tavolo ${key}`, when: r.tavolo_starts_at, rows: [] });
        byTable.get(key).rows.push(r);
      }

      // Meta
      el.meta.textContent = `${filtered.length} prenotazioni visibili${ONLY ? ` per tavolo ${ONLY}` : ''}`;

      // Render
      if (byTable.size === 0) {
        el.content.innerHTML = '<div class="empty">Nessuna prenotazione trovata.</div>';
        return;
      }
      el.content.innerHTML = '<div class="grid"></div>';
      const grid = el.content.querySelector('.grid');

      for (const [tid, group] of byTable) {
        const card = document.createElement('div');
        card.className = 'card';
        const when = group.when ? `<div class="muted">Inizio: ${fmtDate(group.when)}</div>` : '';
        card.innerHTML = `<h2>${group.title}</h2>${when}<div class="muted">Visibile a tutti gli utenti</div>`;

        for (const r of group.rows) {
          const statusClass = r.status ? ` status-${String(r.status).toLowerCase()}` : '';
          const line = document.createElement('div');
          line.className = 'seat' + statusClass;
          line.innerHTML = `
            <div>${fmtDate(r.created_at)}</div>
            <div>${r.display_name || '—'}</div>
            ${r.status ? `<div class="pill">${r.status}</div>` : ''}`;
          card.appendChild(line);
        }
        grid.appendChild(card);
      }
    }

    // 5) Realtime re-fetch when reservations change (optional)
    function subscribeRealtime() {
      try {
        supabase.channel('reservations_changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'reservations' }, async () => {
            const rows = await loadReservations();
            render(rows);
          })
          .subscribe();
      } catch (e) { console.warn('realtime subscribe failed', e); }
    }

    // 6) Boot
    let cache = [];
    async function boot() {
      cache = await loadReservations();
      render(cache);
      subscribeRealtime();
    }
    el.search.addEventListener('input', () => render(cache));
    boot();
  </script>
</body>
</html>
